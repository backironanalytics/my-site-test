---
title: "Dollar Data Science"
output: 
  flexdashboard::flex_dashboard:
    theme: simplex
    orientation: rows
    logo: logo_simple.png
    favicon: logo_simple.png
    

params:
  player: Steph
  games: 5
  

  
---


```{r setup, include=FALSE, echo = FALSE}

library(tidyverse)
library(nbastatR)
library(stringr)
library(caret)
library(ggplot2)
library(ggpubr)
library(knitr)
library(data.table)
library(broom)
library(grid)
library(gridExtra)
library(grDevices)
library(reactablefmtr)
library(formattable)
library(markdown)
library(magick)
library(highcharter)
library(extrafont)
library(cowplot)
library(fmsb)
library(shiny)
library(fontawesome)
library(dplyr)
library(flexdashboard)
library(bslib)





Sys.setenv("VROOM_CONNECTION_SIZE" = 131072 * 2)

gamedata <- game_logs(seasons = 2024, result_types = "team", season_types = c("Regular Season","Playoffs"))
gamedata_current <- game_logs(seasons = 2025, result_types = "team", season_types = c("Regular Season"))

current_season <- "2024-25"
last_season <- "2023-24"

gamedata <- bind_rows(gamedata,gamedata_current)
                              
                            
playerdata <- game_logs(seasons = 2024, result_types = "player", season_types = c("Regular Season","Playoffs"))
playerdata_current <- game_logs(seasons = 2025, result_types = "player", season_types = c("Regular Season"))

playerdata <- bind_rows(playerdata,playerdata_current)

season <- playerdata %>% pull(slugSeason)

player_id <- playerdata %>% filter(str_detect(namePlayer,params$player)) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% pull(idPlayer)

slugteam <- playerdata %>% filter(str_detect(namePlayer,params$player), slugSeason == current_season) %>% pull(slugTeam)

gameids<- playerdata %>% filter(idPlayer == player_id)%>% group_by(idGame) %>% summarize(n = n()) %>% pull(idGame)

player_data <- playerdata %>% filter(idPlayer == player_id[1]) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,ftm,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond, slugSeason,typeSeason, urlPlayerHeadshot,outcomeGame,countDaysRestPlayer,nameTeam)

team_id <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,idTeam) %>% group_by(idTeam) %>% summarize(n = n()) %>% pull(idTeam)

team_id_most_recent <- playerdata %>% filter(idPlayer == player_id) %>% 
    select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
           plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,idTeam) %>% arrange(desc(dateGame)) %>% head(1) %>% pull(idTeam)

team_colors <- nba_teams(league = "NBA")

team_colors <- team_colors %>% filter(idTeam == team_id_most_recent) %>% select(colorsTeam)

photo <- playerdata %>% filter(idPlayer == player_id[1]) %>% head(1) %>% pull(urlPlayerHeadshot)

conference <- unnest(bref_teams_stats(seasons = 2025))

conference <- gamedata %>% group_by(nameTeam,slugTeam) %>% summarize(n = n()) %>% left_join(conference %>% mutate(nameTeam = ifelse(nameTeam == "Los Angeles Clippers","LA Clippers",nameTeam)) %>% group_by(nameTeam,nameConference) %>% summarize(n = n()), by = "nameTeam")



logos <- nba_teams(league = "NBA")
logos <- logos %>% filter(isNonNBATeam == 0) %>% select(idTeam,slugTeam,urlThumbnailTeam)

split_colors <- str_split_fixed(team_colors$colorsTeam,', ',5)
primary_color <- split_colors[,1]
secondary_color <- split_colors[,2]
third_color <- split_colors[,3]

primary_color <- "#FF204E"
secondary_color <- "#333A73"

league_leaders_reg_season <- metrics_leaders(seasons = 2025,  season_types = "Regular Season", modes = "PerGame", return_message = T, metric = "pts")

#gamedata <- gamedata %>% filter(idTeam == team_id)

most_recent = playerdata %>% filter(idPlayer == player_id) %>%
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
        plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% slice(which.max(dateGame)) %>% pull(dateGame)

rest = as.integer(Sys.Date() - most_recent - 1)

next_opponent_table <- schedule %>% filter(Team == slugteam[1])

next_opponent <- next_opponent_table %>% filter(Date == schedule %>% filter(next_game == TRUE,Team == slugteam[1]) %>% pull(Date) %>% min) %>% pull(slugTeam)
next_location <- substring(next_opponent_table %>% filter(Date == schedule %>% filter(next_game == TRUE,Team == slugteam[1]) %>% pull(Date) %>% min)  %>% pull(location),1,1)




```

```{r variables, echo = FALSE }

player_name <- playerdata %>% filter(idPlayer == player_id[1]) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% pull(namePlayer)



slug_team <- all_rosters %>% filter(idPlayer == player_id[1]) %>% select(slugTeam)

team_id_current <- all_rosters %>% filter(idPlayer == player_id[1]) %>% pull(idTeam)

team_name <- slug_team %>% left_join(teams, by = "slugTeam") %>% pull(nameTeam)

team_logo <- teams %>% filter(idTeam == team_id_current) %>% pull(urlThumbnailTeam)

roster_data <- all_rosters %>% filter(idPlayer == player_id[1])
  
```




Summary
=======================================================================

Row  
-----------------------------------------------------------------------

### Season Stats

```{r Season Stats, echo = FALSE, warning = FALSE, message = FALSE, fig.align='left', fig.width = 9, error = TRUE}


pts_per_attempt <- as.data.frame(playerdata %>% filter(slugSeason == current_season,typeSeason == "Regular Season") %>% group_by(namePlayer,idPlayer,slugTeam) %>% summarize(n = n(), pts = sum(pts), fga = sum(fga), min = sum(minutes))  %>% mutate(points_per_attempt = (pts/fga))) %>% mutate(rank = order(order(points_per_attempt, decreasing = T))) %>% arrange(desc(points_per_attempt))

pts_per_attempt_rank <- pts_per_attempt %>% filter(idPlayer == player_id) %>% pull(rank)


pts_per_attempt_avg <- pts_per_attempt %>% filter(idPlayer == player_id) %>% pull(points_per_attempt)
pts_per_attempt_n <- pts_per_attempt %>% filter(idPlayer == player_id) %>% pull(n)

player_data <- playerdata %>% filter(idPlayer == player_id) %>% select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond, slugSeason,typeSeason,ftm,outcomeGame)

player_data_expanded <- playerdata  %>% select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond, slugSeason,typeSeason) %>% group_by(dateGame,locationGame,namePlayer, idPlayer, typeSeason) %>% summarize(n = n()) 

play_play_player <- play_play %>% filter(idPlayerNBA1 == player_id[1], !is.na(slugScore))
play_play_player_assists <- play_play %>% filter(idPlayerNBA2 == player_id[1], str_detect(descriptionPlayHome,"AST") | str_detect(descriptionPlayVisitor,"AST"))
play_play_player_rebounds <- play_play %>% filter(is.na(slugScore),idPlayerNBA1 == player_id[1], str_detect(descriptionPlayHome,"REBOUND") | str_detect(descriptionPlayVisitor,"REBOUND"))
play_play_player_steals <- play_play %>% filter(idPlayerNBA2 == player_id[1], str_detect(descriptionPlayHome,"STEAL") | str_detect(descriptionPlayVisitor,"STEAL"))
play_play_player_blocks <- play_play %>% filter(idPlayerNBA3 == player_id[1], str_detect(descriptionPlayHome,"BLOCK") | str_detect(descriptionPlayVisitor,"BLOCK"))

play_play_all <- play_play %>% filter(!is.na(slugScore))
play_play_all_assists <- play_play %>% filter( str_detect(descriptionPlayHome,"AST") | str_detect(descriptionPlayVisitor,"AST"))
play_play_all_rebounds <- play_play %>% filter(is.na(slugScore), str_detect(descriptionPlayHome,"REBOUND") | str_detect(descriptionPlayVisitor,"REBOUND"))
play_play_all_steals <- play_play %>% filter( str_detect(descriptionPlayHome,"STEAL") | str_detect(descriptionPlayVisitor,"STEAL"))
play_play_all_blocks <- play_play %>% filter(str_detect(descriptionPlayHome,"BLOCK") | str_detect(descriptionPlayVisitor,"BLOCK"))

play_play_makes <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt")))

play_play_makes_expanded <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1, idPlayerNBA1, slugScore,scoreHome,scoreAway, slugTeamPlayer1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame, slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(dateGame,namePlayer1,idPlayerNBA1) %>% summarize(pts = sum(pts))

firstq_makes <- player_data %>% group_by(dateGame,locationGame,typeSeason,slugOpponent,slugSeason) %>% summarize(n = n()) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(dateGame) %>% summarize(pts = sum(pts)), by = "dateGame") %>% mutate(pts = replace_na(pts,0))

firstq_makes_expanded <- player_data_expanded %>% left_join(play_play_makes_expanded %>% rename(idPlayer = idPlayerNBA1), by = c("dateGame","idPlayer")) %>% mutate(pts = replace_na(pts,0))

play_play_assists <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam"))

firstq_assists <- player_data %>% group_by(dateGame,locationGame,typeSeason,slugOpponent,slugSeason) %>% summarize(n = n()) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(dateGame,typeSeason,locationGame) %>% summarize(assists = n()), by = "dateGame") %>% mutate(assists = replace_na(assists,0)) %>% rename(locationGame = locationGame.x, typeSeason = typeSeason.x)

play_play_rebounds <- play_play_player_rebounds %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) 

firstq_rebounds <- player_data %>% group_by(dateGame,locationGame,typeSeason,slugOpponent,slugSeason) %>% summarize(n = n()) %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(dateGame,typeSeason,locationGame) %>% summarize(rebounds = n()), by = "dateGame") %>% mutate(rebounds = replace_na(rebounds,0)) %>% rename(locationGame = locationGame.x, typeSeason = typeSeason.x)

#season <- player_data %>% filter(typeSeason == "Regular Season") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

season <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,slugSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,slugSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season))*0)), nrow = 1, ncol=ncol(season)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_frame <- if(nrow(season)==0){error}else{season}


season_last <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,slugSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,slugSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season",slugSeason == last_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season_last)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season))*0)), nrow = 1, ncol=ncol(season_last)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_last_frame <- if(nrow(season_last)==0){error}else{season_last}



b2b <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE,slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(b2b)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(b2b))*0)), nrow = 1, ncol=ncol(b2b)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
b2b_frame <- if(nrow(b2b)==0){error}else{b2b}

#season_last10 <- player_data %>% arrange(desc(dateGame)) %>% head(10) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg,pts_reb_ast, pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

season_last10 <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% arrange(desc(dateGame)) %>% head(10) %>% group_by(namePlayer) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season_last10)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_last10))*0)), nrow = 1, ncol=ncol(season_last10)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_last10_frame <- if(nrow(season_last10)==0){error}else{season_last10}

#season_last5 <- player_data %>% arrange(desc(dateGame)) %>% head(5) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg,pts_reb_ast,pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

season_last5 <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% arrange(desc(dateGame)) %>% head(5) %>% group_by(namePlayer) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season_last5)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_last5))*0)), nrow = 1, ncol=ncol(season_last5)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_last5_frame <- if(nrow(season_last5)==0){error}else{season_last5}

#season_home <- player_data %>% filter(locationGame == "H", typeSeason == "Regular Season") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg,pts_reb_ast,pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

season_home <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(locationGame == "H", typeSeason == "Regular Season",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season_home)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_home))*0)), nrow = 1, ncol=ncol(season_home)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_home_frame <- if(nrow(season_home)==0){error}else{season_home}


#season_away <- player_data %>% filter(locationGame == "A", typeSeason == "Regular Season") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg,pts_reb_ast,pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

season_away <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(locationGame == "A", typeSeason == "Regular Season",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season_away)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_away))*0)), nrow = 1, ncol=ncol(season_away)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_away_frame <- if(nrow(season_away)==0){error}else{season_away}

#season_opponent <- player_data %>% filter(slugOpponent == next_opponent, typeSeason == "Regular Season") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg,pts_reb_ast,pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

season_opponent <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(slugOpponent == next_opponent, typeSeason == "Regular Season",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(season_opponent)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_opponent))*0)), nrow = 1, ncol=ncol(season_opponent)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_opponent_frame <- if(nrow(season_opponent)==0){error}else{season_opponent}



#playoff <- player_data %>% filter(typeSeason == "Playoffs") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_fg3a = sum(fg3a), total_minutes = sum(minutes), total_tov = sum(tov))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1), tovpg = round(total_tov/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1)) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,fg_percentage,fg3_percentage,tovpg,pts_reb_ast,pts_ast,pts_reb,ast_reb) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

playoff <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Playoffs") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(playoff)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(playoff))*0)), nrow = 1, ncol=ncol(playoff)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
playoff_frame <- if(nrow(playoff)==0){error}else{playoff}


playoff_away <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Playoffs", locationGame == "A") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(playoff_away)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(playoff_away))*0)), nrow = 1, ncol=ncol(playoff_away)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
playoff_away_frame <- if(nrow(playoff_away)==0){error}else{playoff_away}


playoff_home <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Playoffs", locationGame == "H") %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(playoff_home)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(playoff_home))*0)), nrow = 1, ncol=ncol(playoff_home)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
playoff_home_frame <- if(nrow(playoff_home)==0){error}else{playoff_home}


regular_season_w <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", outcomeGame == "W",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(regular_season_w)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(regular_season_w))*0)), nrow = 1, ncol=ncol(regular_season_w)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
regular_season_w_frame <- if(nrow(regular_season_w)==0){error}else{regular_season_w}

regular_season_l <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", outcomeGame == "L",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(regular_season_l)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(regular_season_l))*0)), nrow = 1, ncol=ncol(regular_season_l)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
regular_season_l_frame <- if(nrow(regular_season_l)==0){error}else{regular_season_l}

rest_0 <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", countDaysRestPlayer == 0,slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(rest_0)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(rest_0))*0)), nrow = 1, ncol=ncol(rest_0)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
rest_0_frame <- if(nrow(rest_0)==0){error}else{rest_0}

rest_1 <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", countDaysRestPlayer == 1,slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(rest_1)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(rest_1))*0)), nrow = 1, ncol=ncol(rest_1)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
rest_1_frame <- if(nrow(rest_1)==0){error}else{rest_1}

rest_2 <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", countDaysRestPlayer == 2,slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(rest_2)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(rest_2))*0)), nrow = 1, ncol=ncol(rest_2)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
rest_2_frame <- if(nrow(rest_2)==0){error}else{rest_2}

rest_3 <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", countDaysRestPlayer >= 3,slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(rest_3)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(rest_3))*0)), nrow = 1, ncol=ncol(rest_3)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
rest_3_frame <- if(nrow(rest_3)==0){error}else{rest_3}

western <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% left_join(conference %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", nameConference == "Western",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(western)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(western))*0)), nrow = 1, ncol=ncol(western)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
western_frame <- if(nrow(western)==0){error}else{western}

eastern <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata  %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% left_join(conference %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", nameConference == "Eastern",slugSeason == current_season) %>% group_by(namePlayer,slugSeason) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a)) %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%rename(GP = n,`FG` = fg_percentage, `FG_3P` = fg3_percentage)

names <- colnames(eastern)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(eastern))*0)), nrow = 1, ncol=ncol(eastern)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
eastern_frame <- if(nrow(eastern)==0){error}else{eastern}






Type <- c("2024/25 Regular Season","2023/24 Regular Season","Last 10 GP","Last 5 GP","2024/25 Regular Season Home","2024/25 Regular Season Away",paste("Against",next_opponent,"Regular Season"),"Regular Season Wins","Regular Season Losses","0 Days Rest","1 Day Rest","2 Days Rest","3+ Days Rest","Against Western Conference Opponents","Against Eastern Conference Opponents")

combined <- bind_rows(season_frame,season_last_frame,season_last10_frame,season_last5_frame,season_home_frame,season_away_frame,season_opponent_frame,regular_season_w_frame,regular_season_l_frame,rest_0_frame,rest_1_frame,rest_2_frame,rest_3_frame,western_frame,eastern_frame)


df <- data.frame(Type,combined)

df2 <- df %>% select(Type,GP,min,ppg,rpg,apg,spg,bpg,tovpg,fgmpg,fgapg,threepg,threeattempt,ftmpg,FG,FG_3P,pts_reb_ast,pts_ast,pts_reb,ast_reb,stl_blk,total_first,firstqppg,firstqapg,firstqrpg,pts_per_attempt) %>% 
  rename(Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = FG,
         `3FG%` = FG_3P,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt)

df2 <- replace(df2, is.na(df2),0)

#print.data.frame(df2)

formattable(df2,align = "c",list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Note: Last xx Games Played May Include Last Season's Data")



```






Minutes {data-navmenu="Exploratory Stats" data-navmenu-icon="fa-signal" data-badge="badge bg-warning"}
=======================================================================

Row 
-----------------------------------------------------------------------

### Minutes Per Game {data-width=1300}

```{r Exploratory Min Played, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

library(plotly)
library(ggbreak)


metric = "minutes"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + labs(x = "Date")  + scale_y_continuous(breaks = seq(0,90,2)) + geom_hline(yintercept = avg) + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + theme_minimal() + scale_x_date(breaks = "1 month", date_labels = "%b") + scale_color_manual(values = c(primary_color,secondary_color)) + scale_shape_manual(values = c(15,16)) + facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))

```



### Minutes Histogram

```{r min hist, echo = FALSE, warning = FALSE, message = FALSE}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ scale_x_continuous(breaks = seq(0,90,2))+ ggtitle(toupper(paste(params$player,"Regular Season",metric,"histogram"))) + theme_minimal()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



Points {data-navmenu="Exploratory Stats"}
=======================================================================


Row
-----------------------------------------------------------------------

### Points per Game

```{r}
metric = "pts"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Points per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Points per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Points per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Points per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))


message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```


Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Points Per Game 

```{r Exploratory PPG, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center"}

metric = "pts"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))
avg_opponent <- mean(player_data %>% filter(typeSeason == "Regular Season",slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

consensus <- round((avg *.50) + (avg_lastx *.30) + (avg_opponent * .20),0)

lastDate <- max(player_data$dateGame)

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg)+ scale_y_continuous(breaks = seq(0,90,1)) + theme_minimal() + scale_color_manual(values = c(primary_color,secondary_color)) + scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x") + guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Points Histogram 

```{r pts hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,2))+ ggtitle(toupper(paste(params$player,"Regular Season",metric,"histogram"))) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Points by Location 

```{r PPG boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"Regular Season",metric,"Per Game by location"))) + theme(legend.position="none")+ scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


### Points by Weekday

```{r PPG boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none") + scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

```{r points probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

pts_over_under_new <- seq(from = 1, to = 50, by = 1)

prob <- sapply(pts_over_under_new, function (x){
  
  mean(player_data$pts >= x)
  
})

pts <- pts_over_under_new
probability <- prob


df <- data.frame(Points = pts, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))



```



### O/U Probabilities


```{r points hit rate, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$pts > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$pts <= x)
  
})


df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% mutate(Over = Over/100, Under = Under/100) %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage*100,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + scale_y_continuous(labels = scales::percent) + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = .50, color = "white", linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5), fontface = "bold") + guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```




Assists {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Assists per Game

```{r}
metric = "ast"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Assists per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Assists per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Assists per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Assists per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Assists Per Game 

```{r Exploratory APG, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + scale_y_continuous(breaks = seq(0,90,1)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))

```



### Assists by Location 

```{r APG boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Assists by Weekday

```{r APG boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Assists Histogram

```{r ast hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




```{r assists probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

ast_over_under_new <- seq(from = 1, to = 10, by = 1)

prob <- sapply(ast_over_under_new, function (x){
  
  mean(player_data$ast >= x)
})

ast <- ast_over_under_new
probability <- prob


df <- data.frame(Assists = ast, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))



```


### O/U Probabilities


```{r points hit rate assists, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$ast > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$ast <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type"))  %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```


Rebounds {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Rebounds per Game

```{r}
metric = "treb"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Rebounds per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Rebounds per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Rebounds per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Rebounds per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Rebounds Per Game

```{r Exploratory RPG, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "treb"
avg <- mean(player_data%>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + scale_y_continuous(breaks = seq(0,90,1)) + geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))

```



### Rebounds by Location

```{r RPG boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Rebounds by Weekday

```{r RPG boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Rebounds Histogram

```{r treb hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




```{r trebounds probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

reb_over_under_new <- seq(from = 1, to = 10, by = 1)

prob <- sapply(reb_over_under_new, function (x){
  
  mean(player_data$treb >= x)
})

reb <- reb_over_under_new
probability <- prob


df <- data.frame(Rebounds = reb, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))



```


### O/U Probabilities


```{r points hit rate rebounds, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$treb > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$treb <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type"))  %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```



Steals {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Steals per Game

```{r}
metric = "stl"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Steals per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Steals per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Steals per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Steals per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------



### Steals Per Game

```{r Exploratory SPG, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + scale_y_continuous(breaks = seq(0,90,1)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Steals by Location

```{r SPG boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))


ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Steals by Weekday

```{r SPG boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Steals Histogram

```{r stl hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 6, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




```{r steals probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

stl_over_under_new <- seq(from = 1, to = 5, by = 1)

prob <- sapply(stl_over_under_new, function (x){
  
  mean(player_data$stl >= x)
})

stl <- stl_over_under_new
probability <- prob


df <- data.frame(Steals = stl, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))



```


### O/U Probabilities


```{r points hit rate steals, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$stl > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$stl <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type"))  %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```

Three Pointers Made {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Three's Made per Game

```{r}
metric = "fg3m"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Three's Made per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Three's Made per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Three's Made per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Three's Made per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Three Pointers Made Per Game

```{r Exploratory 3fgmPG, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + scale_y_continuous(breaks = seq(0,90,1))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Three Pointers Made by Location

```{r fg3m boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```

### Three Pointers Made by Weekday

```{r fg3m boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Three Pointers Made Histogram

```{r fg3m hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



```{r fg3m prob, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

fg3m_over_under <- seq(from = 0, to = 5, by = 1)

prob <- sapply(fg3m_over_under, function(x){

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m) 

mean(dat$fg3m >= x)

})

fg3m_list <- fg3m_over_under
probability <- prob



df <- data.frame(FG3M = fg3m_over_under, Probability = round(prob,1))

df %>% ggplot(aes(FG3M,Probability)) + geom_point()  + scale_y_continuous(breaks = seq(0,1,.1)) + scale_x_continuous(breaks = fg3m_over_under) + ggtitle(toupper(paste(params$player,"Probability of fg3m"))) + geom_hline(yintercept = 0.5)


```



```{r fg3m prob table, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.width = 9, eval = FALSE}

fg3m_over_under <- seq(from = 1, to = 5, by = 1)

prob <- sapply(fg3m_over_under, function(x){

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m) 

mean(dat$fg3m >= x)

})

dat_fg3m <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m)

df <- data.frame(FG3M = fg3m_over_under, Probability = round(prob*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))


```


### O/U Probabilities


```{r points hit rate threes, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

fg3m_over_under <- seq(from = 1, to = 5, by = 1)

prob <- sapply(fg3m_over_under, function(x){

dat <- playerdata %>% filter(idPlayer == player_id, slugSeason == current_season) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m) 

mean(dat$fg3m >= x)

})

dat_fg3m <- playerdata %>% filter(idPlayer == player_id, slugSeason == current_season) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m)






player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$fg3m > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$fg3m <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type"))  %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```

Three Pointers Attempted {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Three's Attempted per Game

```{r}
metric = "fg3a"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Three's Attempted per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Three's Attempted per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Three's Attempted per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Three's Attempted per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Three Pointers Attempted Per Game

```{r Exploratory 3fgaPG, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + scale_y_continuous(breaks = seq(0,90,1))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Three Pointers Attempted by Location

```{r fg3a boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```

### Three Pointers Attempted by Weekday

```{r fg3a boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Three Pointers Attempted Histogram

```{r fg3a hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




### O/U Probabilities


```{r points hit rate threes attempted, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

fg3a_over_under <- seq(from = 1, to = 12, by = 1)

prob <- sapply(fg3a_over_under, function(x){

dat <- playerdata %>% filter(idPlayer == player_id, slugSeason == current_season) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m,fg3a) 

mean(dat$fg3a >= x)

})

dat_fg3a <- playerdata %>% filter(idPlayer == player_id, slugSeason == current_season) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,fg3m,fg3a)






player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$fg3a > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$fg3a <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type"))  %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```


Turnovers {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Turnovers per Game

```{r}
metric = "tov"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Turnovers per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Turnovers per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Turnovers per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Turnovers per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Turnovers Per Game

```{r Exploratory tov, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + scale_y_continuous(breaks = seq(0,90,1)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Turnovers by Location

```{r tov boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Turnovers by Weekday

```{r tov boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


### Turnovers Histogram

```{r tov hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 6, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




```{r turnovers probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

tov_over_under_new <- seq(from = 1, to = 5, by = 1)

prob <- sapply(tov_over_under_new, function (x){
  
  mean(player_data$tov >= x)
})

tov <- tov_over_under_new
probability <- prob


df <- data.frame(Turnovers = tov, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))



```


### O/U Probabilities


```{r points hit rate tov, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$tov > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$tov <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```

Blocks {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Blocks per Game

```{r}
metric = "blk"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Blocks per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Blocks per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Blocks per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Blocks per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Blocks Per Game

```{r Exploratory blk per game, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + scale_y_continuous(breaks = seq(0,90,1)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"per game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Blocks by Location

```{r blk boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Blocks by Weekday

```{r blk boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### Blocks Histogram

```{r blk hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 6, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




```{r blocks probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

blk_over_under_new <- seq(from = 1, to = 5, by = 1)

prob <- sapply(blk_over_under_new, function (x){
  
  mean(player_data$blk >= x)
})

blk <- blk_over_under_new
probability <- prob


df <- data.frame(Blocks = blk, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))



```


### O/U Probabilities


```{r points hit rate blocks, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$blk > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$blk <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```

Points + Rebounds + Assists {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Pts+Reb+Ast per Game

```{r}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_ast_total,typeSeason,slugOpponent,slugSeason)

metric = "pt_reb_ast_total"

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Pts+Reb+Ast per Game Last 5

```{r}

avg_lastx <- mean(dat %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Pts+Reb+Ast per Game Home Games

```{r}

avg_home <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Pts+Reb+Ast per Game Away Games

```{r}

avg_away <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Pts+Reb+Ast per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(dat %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```

Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Pts+Reb+Ast Per Game

```{r pts_treb_ast trend, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

 

dat_combined <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_ast_total,typeSeason,slugSeason) 

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(pt_reb_ast_total))
avg_lastx <- mean(dat %>% head(params$games) %>% pull(pt_reb_ast_total))


season_rank <- playerdata %>% filter(typeSeason == "Regular Season", slugSeason == current_season)  %>% 
    select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
           plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
    arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% group_by(namePlayer) %>% summarize(n = n(),total = sum(pt_reb_ast_total), minutes = sum(minutes)) %>% mutate(totalpg = total/n, minutepg = minutes/n) %>% mutate(rank = order(order(totalpg, decreasing = T))) %>% arrange(desc(totalpg)) %>% filter(namePlayer == params$player) %>% pull(rank) 

playoff_rank <- playerdata %>% filter(typeSeason == "Playoffs")  %>% 
    select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
           plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
    arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% group_by(namePlayer) %>% summarize(n = n(),total = sum(pt_reb_ast_total), minutes = sum(minutes)) %>% mutate(totalpg = total/n, minutepg = minutes/n) %>% mutate(rank = order(order(totalpg, decreasing = T))) %>% arrange(desc(totalpg)) %>% filter(namePlayer == params$player) %>% pull(rank) 


p <- dat %>% ggplot(aes(dateGame,pt_reb_ast_total, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + geom_smooth(span = 0.6) +labs(x = "Date") + scale_y_continuous(breaks = seq(0,60,2)) + ggtitle(toupper(paste(params$player,"Pts+reb+ast")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + labs(caption = paste("Season Rank:",season_rank," Playoff Rank:",playoff_rank)) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"Pts+reb+ast",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))




```



```{r pts_treb_ast distribution, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

 
p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(date_label = factor(dateGame)) %>% arrange(desc(dateGame)) %>% head(10) %>% pivot_longer(!c(dateGame,date_label,locationGame,typeSeason,slugOpponent), names_to = "Type", values_to = "pt_reb_ast") %>% filter(Type != "pt_reb_ast_total") %>% ggplot(aes(x = date_label,y = pt_reb_ast, fill = factor(Type, levels =c("treb","ast","pts")))) + geom_bar(position = "fill", stat = "identity") + theme_minimal() + scale_y_continuous(labels = scales::percent)  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + labs(x = "Date", y = "Pts+Reb+Ast")

ggplotly(p, tooltip = list("Type","pt_reb_ast","slugOpponent","locationGame")) %>% layout(title = list(text = toupper(paste(params$player,metric,"Pts+Reb+Ast Distribution",'<br>','<sup>',toupper("Regular Season Last 10 Games"),'</sup>'))), legend = list(title = list(text = "Type"))) 





```



### Pts+Reb+Ast by Location

```{r pts_treb_ast boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "pt_reb_ast_total"



p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Pts+Reb+Ast by Weekday

```{r pt_reb_ast boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Pts+Reb+Ast Histogram

```{r pts_treb_ast, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- playerdata %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,pt_reb_ast_total) %>% ggplot(aes(pt_reb_ast_total)) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + ggtitle(toupper(paste(params$player,"Pts + Reb + Ast Regular Season histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



```{r pts_treb_ast prob graph, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

pts_reb_ast_over_under <- seq(from = 8, to = 54, by = 1)

prob <- sapply(pts_reb_ast_over_under, function(x){

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,pt_reb_ast_total) 

mean(dat$pt_reb_ast_total >= x)

})

pts_reb_ast <- pts_reb_ast_over_under
probability <- prob



df <- data.frame(Points_Reb_Ast = pts_reb_ast, Probability = round(probability,1))

df %>% ggplot(aes(Points_Reb_Ast,Probability)) + geom_point()  + scale_y_continuous(breaks = seq(0,1,.1)) + scale_x_continuous(breaks = seq(from = 8, to = 54, by = 2)) + ggtitle(toupper(paste(params$player,"Probability of Pts+Reb+Ast"))) + geom_hline(yintercept = 0.5)


```




```{r pts_treb_ast prob, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.width = 9, eval = FALSE}



pts_reb_ast_over_under <- seq(from = 8, to = 54, by = 1)

prob <- sapply(pts_reb_ast_over_under, function(x){

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,pts,treb,ast,pt_reb_ast_total) 

mean(dat$pt_reb_ast_total >= x)

})

df <- data.frame(Pts_Reb_Ast = pts_reb_ast_over_under, Probability = round(prob*100,1))

#print.data.frame(df, row.names=pts_reb_ast_over_under)

color <- formatter("span", style = x ~ style(font.weight = "bold", color = ifelse(x >= 90,"green","orange")))

formattable(df,align = c("c","c"),list(Probability = color_bar(primary_color)))

```


### O/U Probabilities


```{r points hit rate pt_reb_ast, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$pt_reb_ast_total > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$pt_reb_ast_total <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```




```{r pts_treb_ast trend minutes, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_ast_total,minutes,typeSeason) 

avg <- mean(dat$pt_reb_ast_total)

fit <- lm(pt_reb_ast_total ~ minutes, data = dat)
coefs <- tidy(fit, conf.int = TRUE)

dat %>% ggplot(aes(x = dateGame)) + geom_line(aes(y = pt_reb_ast_total, group = 1), color = "blue") + geom_line(aes(y = minutes, group = 1), color = "red") + theme_minimal() +labs(x = "Date") + scale_y_continuous(breaks = seq(0,60,2)) + ggtitle(toupper(paste(params$player,"Blue: Pts+reb+ast","Red: Minutes")))+ geom_hline(yintercept = avg) 


```

```{r pts_treb_ast trend minutes coeff, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', eval = FALSE}

formattable(coefs)

```

```{r pts_treb_ast trend minutes coeff plot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

dat$rhat <- predict(fit, newdata = dat)

dat %>% ggplot(aes(rhat, pt_reb_ast_total, label = dateGame)) + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_abline()+ geom_text(nudge_x = 0.4,nudge_y = -0.5, cex = 2) + theme_minimal() + labs(x = "pt_reb_ast_total linear model")

```

```{r pt_reb_ast total, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}


playerdata  %>% 
    select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
           plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
    arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% group_by(namePlayer) %>% summarize(n = n(),total = sum(pt_reb_ast_total), minutes = sum(minutes)) %>% mutate(totalpg = total/n, minutepg = minutes/n) %>% arrange(desc(totalpg)) %>% ggplot(aes(minutepg,totalpg)) + geom_point() + theme_minimal() + geom_abline(lty = 2, color = "red") + ggtitle("Pts+Reb+Ast to Minutes") + labs(y = "Pt+Reb+Ast Per Game", x = "Minutes Per Game")

```


Points + Assists {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Pts+Ast per Game

```{r}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_ast_total = pts+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_ast_total,typeSeason,slugOpponent,slugSeason) 

metric = "pt_ast_total"

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Pts+Ast per Game Last 5

```{r}

avg_lastx <- mean(dat %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Pts+Ast per Game Home Games

```{r}

avg_home <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Pts+Ast per Game Away Games

```{r}

avg_away <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Pts+Ast per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(dat %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Pts+Ast Per Game

```{r pts_ast trend, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



dat_combined <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_ast_total = pts+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_ast_total,typeSeason,slugSeason) 

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(pt_ast_total))
avg_lastx <- mean(dat %>% head(params$games) %>% pull(pt_ast_total))




p <- dat %>% ggplot(aes(dateGame,pt_ast_total, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + geom_smooth(span = 0.6) +labs(x = "Date") + scale_y_continuous(breaks = seq(0,60,2)) + ggtitle(toupper(paste(params$player,"Pts+reb+ast")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + labs(caption = paste("Season Rank:",season_rank," Playoff Rank:",playoff_rank)) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"Pts+ast",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))




```


### Pts+Ast by Location

```{r pts_ast boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "pt_ast_total"



p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Pts+Ast by Weekday

```{r pts_ast boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Pts+Ast Histogram

```{r pts_ast, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- playerdata %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_ast_total = pts+ast) %>% select(dateGame,pts,treb,ast,pt_ast_total) %>% ggplot(aes(pt_ast_total)) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + ggtitle(toupper(paste(params$player,"Pts + Ast regular season histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




### O/U Probabilities


```{r points hit rate pt_ast, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$pt_ast_total > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$pt_ast_total <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```


Points + Rebounds {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Pts+Reb per Game

```{r}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_total = pts+treb) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_total,typeSeason,slugOpponent,slugSeason) 

metric = "pt_reb_total"

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Pts+Reb per Game Last 5

```{r}

avg_lastx <- mean(dat %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Pts+Reb per Game Home Games

```{r}

avg_home <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Pts+Reb per Game Away Games

```{r}

avg_away <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Pts+Reb per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(dat %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Pts+Reb Per Game

```{r pts_reb trend, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


dat_combined <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_total = pts+treb) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_total,typeSeason,slugSeason) 

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(pt_reb_total))
avg_lastx <- mean(dat %>% head(params$games) %>% pull(pt_reb_total))




p <- dat %>% ggplot(aes(dateGame,pt_reb_total, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + geom_smooth(span = 0.6) +labs(x = "Date") + scale_y_continuous(breaks = seq(0,60,2)) + ggtitle(toupper(paste(params$player,"Pts+reb+ast")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + labs(caption = paste("Season Rank:",season_rank," Playoff Rank:",playoff_rank)) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"Pts+reb",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))




```



### Pts+Reb by Location

```{r pts_reb boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "pt_reb_total"



p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Pts+Reb by Weekday

```{r pts_reb boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### Pts+Reb Histogram

```{r pts_reb, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- playerdata %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_total = pts+treb) %>% select(dateGame,pts,treb,ast,pt_reb_total) %>% ggplot(aes(pt_reb_total)) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + ggtitle(toupper(paste(params$player,"Pts + Reb regular seasonhistogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




### O/U Probabilities


```{r points hit rate pt_reb, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$pt_reb_total > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$pt_reb_total <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```

Rebounds + Assists {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Reb+Ast per Game

```{r}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),reb_ast_total = ast+treb) %>% select(dateGame,locationGame,pts,treb,ast,reb_ast_total,typeSeason,slugOpponent,slugSeason)  

metric = "reb_ast_total"

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Reb+Ast per Game Last 5

```{r}

avg_lastx <- mean(dat %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Reb+Ast per Game Home Games

```{r}

avg_home <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Reb+Ast per Game Away Games

```{r}

avg_away <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Reb+Ast per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(dat %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Reb+Ast Per Game

```{r reb_ast trend, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



dat_combined <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),reb_ast_total = ast+treb) %>% select(dateGame,locationGame,pts,treb,ast,reb_ast_total,typeSeason,slugSeason) 

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(reb_ast_total))
avg_lastx <- mean(dat %>% head(params$games) %>% pull(reb_ast_total))




p <- dat %>% ggplot(aes(dateGame,reb_ast_total, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + geom_smooth(span = 0.6) +labs(x = "Date") + scale_y_continuous(breaks = seq(0,60,2)) + ggtitle(toupper(paste(params$player,"Reb+Ast")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + labs(caption = paste("Season Rank:",season_rank," Playoff Rank:",playoff_rank)) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"Reb+Ast",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))




```


### Reb+Ast by Location

```{r reb_ast boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "reb_ast_total"



p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Reb+Ast by Weekday

```{r reb_ast boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Pts+Reb Histogram

```{r reb_ast, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- playerdata %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),reb_ast_total = ast+treb) %>% select(dateGame,pts,treb,ast,reb_ast_total) %>% ggplot(aes(reb_ast_total)) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + ggtitle(toupper(paste(params$player,"Reb + Ast regular season histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




### O/U Probabilities


```{r hit rate ast_reb, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$reb_ast_total > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$reb_ast_total <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```



Steals + Blocks {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Steals+Blocks per Game

```{r}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),stl_blk_total = stl+blk) %>% select(dateGame,locationGame,pts,treb,ast,stl_blk_total,typeSeason,slugOpponent,slugSeason)  

metric = "stl_blk_total"

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Steals+Blocks per Game Last 5

```{r}

avg_lastx <- mean(dat %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Steals+Blocks per Game Home Games

```{r}

avg_home <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Steals+Blocks per Game Away Games

```{r}

avg_away <- mean(dat %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Steals+Blocks per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(dat %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### Steals+Blocks Per Game

```{r stl_blk trend, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



dat_combined <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason,slugSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),stl_blk_total = stl+blk) %>% select(dateGame,locationGame,pts,treb,ast,stl_blk_total,typeSeason,slugSeason) 

avg <- mean(dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(stl_blk_total))
avg_lastx <- mean(dat %>% head(params$games) %>% pull(stl_blk_total))




p <- dat %>% ggplot(aes(dateGame,stl_blk_total, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + geom_smooth(span = 0.6) +labs(x = "Date") + scale_y_continuous(breaks = seq(0,60,2)) + ggtitle(toupper(paste(params$player,"Reb+Ast")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg) + labs(caption = paste("Season Rank:",season_rank," Playoff Rank:",playoff_rank)) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b")+ facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"Stl+Blk",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))




```


### Steals+Blocks by Location

```{r stl_blk boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "stl_blk_total"



p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Steals+Blocks by Weekday

```{r stl_blk boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Steals+Blocks Histogram

```{r stl_blk, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



p <- playerdata %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),stl_blk_total = stl+blk) %>% select(dateGame,pts,treb,ast,stl_blk_total) %>% ggplot(aes(stl_blk_total)) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + ggtitle(toupper(paste(params$player,"Stl + Blk regular season histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




### O/U Probabilities


```{r hit rate stl_blk, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$stl_blk_total > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(player_data_regular$stl_blk_total <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```

Total Free Throws Made {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Free Throws Made per Game

```{r}
metric = "ftm"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Free Throws Made per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Free Throws Made per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Free Throws Made per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Free Throws Made per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))


message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```


Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Free Throws Made Per Game 

```{r Exploratory FTM, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center"}

metric = "ftm"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))
avg_opponent <- mean(player_data %>% filter(typeSeason == "Regular Season",slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

consensus <- round((avg *.50) + (avg_lastx *.30) + (avg_opponent * .20),0)

lastDate <- max(player_data$dateGame)

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg)+ scale_y_continuous(breaks = seq(0,90,1)) + theme_minimal() + scale_color_manual(values = c(primary_color,secondary_color)) + scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x") + guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Free Throws Made Histogram 

```{r ftm hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,2))+ ggtitle(toupper(paste(params$player,"Regular Season",metric,"histogram"))) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Free Throws Made by Location 

```{r FTM boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"Regular Season",metric,"Per Game by location"))) + theme(legend.position="none")+ scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


### Free Throws Made by Weekday

```{r FTM boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none") + scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### O/U Probabilities


```{r ftm hit rate, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$ftm > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$ftm <= x)
  
})


df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% mutate(Over = Over/100, Under = Under/100) %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage*100,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + scale_y_continuous(labels = scales::percent) + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = .50, color = "white", linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5), fontface = "bold") + guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```


Total Field Goals Made {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Field Goals Made per Game

```{r}
metric = "fgm"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Field Goals Made per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Field Goals Made per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Field Goals Made per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Field Goals Made per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))


message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```


Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Field Goals Made Per Game 

```{r Exploratory FGM, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center"}

metric = "fgm"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))
avg_opponent <- mean(player_data %>% filter(typeSeason == "Regular Season",slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

consensus <- round((avg *.50) + (avg_lastx *.30) + (avg_opponent * .20),0)

lastDate <- max(player_data$dateGame)

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg)+ scale_y_continuous(breaks = seq(0,90,1)) + theme_minimal() + scale_color_manual(values = c(primary_color,secondary_color)) + scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x") + guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Field Goals Made Histogram 

```{r fgm hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,2))+ ggtitle(toupper(paste(params$player,"Regular Season",metric,"histogram"))) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Field Goals Made by Location 

```{r FGM boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"Regular Season",metric,"Per Game by location"))) + theme(legend.position="none")+ scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


### Field Goals Made by Weekday

```{r FGM boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none") + scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### O/U Probabilities


```{r fgm hit rate, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$fgm > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$fgm <= x)
  
})


df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% mutate(Over = Over/100, Under = Under/100) %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage*100,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + scale_y_continuous(labels = scales::percent) + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = .50, color = "white", linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5), fontface = "bold") + guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```

Total Field Goals Attempted {data-navmenu="Exploratory Stats"}
=======================================================================

Row
-----------------------------------------------------------------------

### Field Goals Attempted per Game

```{r}
metric = "fga"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Field Goals Attempted per Game Last 5

```{r}

avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Field Goals Attempted per Game Home Games

```{r}

avg_home <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Field Goals Attempted per Game Away Games

```{r}

avg_away <- mean(player_data %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Field Goals Attempted per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(player_data %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))


message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```


Row  {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Field Goals Attempted Per Game 

```{r Exploratory FGA, echo = FALSE, warning = FALSE, message = FALSE, fig.align = "center"}

metric = "fga"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))
avg_lastx <- mean(player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(metric))
avg_opponent <- mean(player_data %>% filter(typeSeason == "Regular Season",slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

consensus <- round((avg *.50) + (avg_lastx *.30) + (avg_opponent * .20),0)

lastDate <- max(player_data$dateGame)

p <- player_data %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))))+ geom_hline(yintercept = avg)+ scale_y_continuous(breaks = seq(0,90,1)) + theme_minimal() + scale_color_manual(values = c(primary_color,secondary_color)) + scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x") + guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



### Field Goals Attempted Histogram 

```{r fga hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 10, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,2))+ ggtitle(toupper(paste(params$player,"Regular Season",metric,"histogram"))) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### Field Goals Attempted by Location 

```{r FGA boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"Regular Season",metric,"Per Game by location"))) + theme(legend.position="none")+ scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


### Field Goals Attempted by Weekday

```{r FGA boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none") + scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### O/U Probabilities


```{r fga hit rate, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


player_data_regular <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$fga > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){
  
  mean(player_data_regular$fga <= x)
  
})


df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% mutate(Over = Over/100, Under = Under/100) %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage*100,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + scale_y_continuous(labels = scales::percent) + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = .50, color = "white", linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5), fontface = "bold") + guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```



First Quarter Points {data-navmenu="First Quarter Analysis" data-navmenu-icon="fa-chart-line"}
=======================================================================

Row
-----------------------------------------------------------------------

### Points per Game

```{r}

metric = "pts"

avg <- mean(firstq_makes %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Points per Game Last 5

```{r}

avg_lastx <- mean(firstq_makes %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Points per Game Home Games

```{r}

avg_home <- mean(firstq_makes %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Points per Game Away Games

```{r}

avg_away <- mean(firstq_makes %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Points per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(firstq_makes %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------



### First Quarter Points Per Game

```{r 1st quarter pts avg, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

play_play_miss <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor) %>% mutate(miss_flag = str_detect(descriptionPlayVisitor,"MISS") | str_detect(descriptionPlayNeutral,"MISS") | str_detect(descriptionPlayHome,"MISS"))%>% mutate(free_throw_flag = str_detect(descriptionPlayNeutral,"Free Throw") | str_detect(descriptionPlayHome,"Free Throw") | str_detect(descriptionPlayVisitor,"Free Throw")) %>% mutate(three_point_flag = str_detect(descriptionPlayNeutral,"3PT") | str_detect(descriptionPlayHome,"3PT") | str_detect(descriptionPlayVisitor,"3PT"))  %>% mutate(two_point_flag = ifelse(miss_flag == TRUE & (is.na(free_throw_flag) & is.na(three_point_flag)),TRUE,FALSE)) %>% select(idGame,numberPeriod,miss_flag,free_throw_flag,three_point_flag,two_point_flag) %>% filter(miss_flag == TRUE)%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame) %>% summarize(n = n()), by = "idGame")

avg <- player_data %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(dateGame) %>% summarize(n = n()) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(dateGame) %>% summarize(pts = sum(pts)), by = "dateGame") %>% mutate(pts = replace_na(pts,0)) %>% summarize(avg = mean(pts)) %>% pull(avg)

avg_lastx <- player_data %>% arrange(desc(dateGame)) %>% head(params$games) %>% group_by(dateGame) %>% summarize(n = n()) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(dateGame) %>% summarize(pts = sum(pts)), by = "dateGame") %>% mutate(pts = replace_na(pts,0)) %>% summarize(avg = mean(pts)) %>% pull(avg)

num_period <- seq(1:4)

percentile <- lapply(num_period, function(x){
  
play_play_all %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugTeam","slugSeason")) %>% filter(!is.na(slugTeam), typeSeason == "Regular Season", numberPeriod <= 4,slugSeason == current_season) %>% mutate(ppg = round(pts/n,1)) %>% filter(numberPeriod == x) %>% mutate(percentile = percent_rank(ppg)*100) %>% filter(idPlayer == player_id[1]) %>% pull(percentile)
  
})

percentile_points_q1 <- percentile[1]
percentile_points_q2 <- percentile[2]
percentile_points_q3 <- percentile[3]
percentile_points_q4 <- percentile[4]


p <- firstq_makes %>% ggplot(aes(dateGame,pts, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason))+ theme_minimal() +labs(x = "Date") + scale_y_continuous(breaks = seq(0,90,1)) + ggtitle(toupper(paste(params$player,"1st Quarter Pts")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + geom_hline(yintercept = avg) + geom_smooth(span = 0.6) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"1st Quarter Pts",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))

```



### First Quarter Points by Location

```{r 1q pts boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "pts"



p <- firstq_makes %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```

### First Quarter Points by Weekday

```{r 1q pts boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- firstq_makes %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### First Quarter Points Histogram

```{r 1q pts hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- firstq_makes %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 6, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```




```{r 1q fga, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

period <- 1

makes <- play_play_makes %>% filter(score_type != "Free Throw") %>% group_by(idGame,dateGame,typeSeason,locationGame,numberPeriod) %>% summarize(pts = sum(pts), make = n()) 

miss <- play_play_miss %>% filter(is.na(free_throw_flag)) %>% group_by(idGame,dateGame,typeSeason,locationGame,numberPeriod) %>% summarize(miss = n())

attempt_total <- makes %>% left_join(miss, by = c("idGame","numberPeriod")) %>% select(idGame,dateGame.x,typeSeason.x,locationGame.x,pts,numberPeriod,make,miss) %>% mutate(miss = replace_na(miss,0)) %>% mutate(attempts = make + miss) %>% rename(dateGame = dateGame.x, typeSeason = typeSeason.x,locationGame = locationGame.x)

attempt_period <- attempt_total %>% filter(numberPeriod == period)

attempt <- attempt_total %>% left_join(attempt_period, by = "idGame") %>% select(idGame,dateGame.x,typeSeason.x,locationGame.x,pts.x,numberPeriod.x,make.x,miss.x,attempts.x,attempts.y) %>% rename(dateGame = dateGame.x, typeSeason = typeSeason.x,locationGame = locationGame.x,pts = pts.x, numberPeriod = numberPeriod.x, make = make.x, miss = miss.x, attempts_total = attempts.x, attempts_first = attempts.y) %>% mutate(attempts_first = replace_na(attempts_first,0))


avg <- round(mean(attempt %>% filter(typeSeason == "Regular Season", numberPeriod == period, slugSeason == current_season) %>% pull(attempts_first)),1)
avg <- replace(avg, is.na(avg),0)
avg_lastx <- round(mean(attempt %>% filter(numberPeriod == period)  %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(attempts_first)),1)
avg_lastx <- replace(avg_lastx, is.na(avg_lastx),0)

p <- attempt %>% ggplot(aes(dateGame,attempts_first)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason))+ theme_minimal() +labs(x = "Date") + scale_y_continuous(breaks = seq(0,90,1)) + ggtitle(toupper(paste(params$player,"1st Quarter FGA")), subtitle = toupper(paste("Season Avg:",avg,"/","Avg Last", params$games,"games:",avg_lastx))) + geom_smooth(span = 0.6) + geom_hline(yintercept = avg)


ggplotly(p) %>% layout(legend = list(orientation = "h"))

```





```{r probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", include = FALSE}

pt_over_under_new <- seq(from = 1, to = 20, by = 1)

prob <- sapply(pt_over_under_new, function (x){
  mean(firstq_makes$pts >= x)
})

pts <- pt_over_under_new
probability <- prob


df <- data.frame(Points = pts, Probability = round(probability*100,1))

df %>% ggplot(aes(pts,probability)) + geom_point() + scale_y_continuous(breaks = seq(0,1,.1)) + scale_x_continuous(breaks = pt_over_under_new) + ggtitle(toupper(paste(params$player,"1Q Probability of Pts Scored"))) + geom_hline(yintercept = 0.5)



```



```{r probability table, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.width = 9, eval = FALSE}

df <- data.frame(Points = pts, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))
```


### O/U Probabilities


```{r points hit rate first q points, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(firstq_makes %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% pull(pts) > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(firstq_makes %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% pull(pts) <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```


First Quarter Assists {data-navmenu="First Quarter Analysis"}
=======================================================================

Row
-----------------------------------------------------------------------

### Assists per Game

```{r}

metric = "assists"

avg <- mean(firstq_assists %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Assists per Game Last 5

```{r}

avg_lastx <- mean(firstq_assists %>% filter(slugSeason == current_season) %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Assists per Game Home Games

```{r}

avg_home <- mean(firstq_assists %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Assists per Game Away Games

```{r}

avg_away <- mean(firstq_assists %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Assists per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(firstq_assists %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### First Quarter Assists Per Game


```{r 1q assists, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



avg <- mean(firstq_assists %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(assists))

avg_lastx <- mean(firstq_assists %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(assists))

p <- firstq_assists %>% ggplot(aes(dateGame,assists, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason))+ theme_minimal() +labs(x = "Date") + scale_y_continuous(breaks = seq(0,90,1)) + ggtitle(toupper(paste(params$player,"1st Quarter Assists")), subtitle = toupper(paste("Season Avg:", round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + geom_smooth(span = 0.6) + geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))


ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"1st Quarter Assists",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))

```



### First Quarter Assists by Location

```{r 1q ast boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "assists"



p <- firstq_assists %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```

### First Quarter Assists by Weekday

```{r 1q ast boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- firstq_assists %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```



### First Quarter Assists Histogram

```{r 1q ast hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- firstq_assists %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 6, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


```{r assist probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

ast_over_under_new <- seq(from = 1, to = 9, by = 1)

prob <- sapply(ast_over_under_new, function (x){
  mean(firstq_assists$assists >= x)
})

ast <- ast_over_under_new
probability <- prob


df <- data.frame(Assists = ast, Probability = round(probability*100,1))

df %>% ggplot(aes(ast,probability)) + geom_point() + scale_y_continuous(breaks = seq(0,1,.1)) + scale_x_continuous(breaks = ast_over_under_new) + ggtitle(toupper(paste(params$player,"1Q Probability of Assists"))) + geom_hline(yintercept = 0.5)



```




```{r assists probability table, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.width = 9, eval = FALSE}

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))

```

### O/U Probabilities


```{r points hit rate first q assists, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(firstq_assists %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% pull(assists) > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(firstq_assists %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% pull(assists) <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))



```



First Quarter Rebounds {data-navmenu="First Quarter Analysis"}
=======================================================================

Row
-----------------------------------------------------------------------

### Rebounds per Game

```{r}

metric = "rebounds"

avg <- mean(firstq_rebounds %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg,1), icon = "fa-solid fa-basketball")
```

### Rebounds per Game Last 5

```{r}

avg_lastx <- mean(firstq_rebounds %>% filter(slugSeason == current_season) %>% arrange(desc(dateGame)) %>% head(5) %>% pull(metric))

valueBox(round(avg_lastx,1), icon = "fa-solid fa-basketball")
```

### Rebounds per Game Home Games

```{r}

avg_home <- mean(firstq_rebounds %>% filter(typeSeason == "Regular Season", locationGame == "H", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_home,1), icon = "fa-solid fa-basketball")
```

### Rebounds per Game Away Games

```{r}

avg_away <- mean(firstq_rebounds %>% filter(typeSeason == "Regular Season", locationGame == "A", slugSeason == current_season) %>% pull(metric))

valueBox(round(avg_away,1), icon = "fa-solid fa-basketball")
```


### Rebounds per Game Against Next Opponent: `r next_opponent`

```{r}

avg_opp <- mean(firstq_rebounds %>% filter(typeSeason == "Regular Season", slugOpponent == next_opponent, slugSeason == current_season) %>% pull(metric))

message <- if(is.na(avg_opp)){
  avg
} else {
  avg_opp
}

valueBox(round(avg_opp,1), icon = "fa-solid fa-basketball")
```

### Consensus Estimate

```{r}

avg_weight <- 0.5
location_weight <- 0.1
opp_weight <- 0.3
last_5_weight <- 0.1


prediction <- if(next_location == "H"){
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_home),avg,avg_home) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
} else{
  (avg * avg_weight) + (avg_lastx * last_5_weight) + (ifelse(is.na(avg_away),avg,avg_away) * location_weight) + (ifelse(is.na(avg_opp),avg,avg_opp) * opp_weight)
}


valueBox(round(prediction,1), icon = "fa-solid fa-spinner", color = "#D9230F")
```



Row {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------


### First Quarter Rebounds Per Game


```{r 1q rebounds, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}



avg <- mean(firstq_rebounds %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% pull(rebounds))

avg_lastx <- mean(firstq_rebounds  %>% arrange(desc(dateGame)) %>% head(params$games) %>% pull(rebounds))

p <- firstq_rebounds  %>% ggplot(aes(dateGame,rebounds, label = slugOpponent)) + geom_line() + geom_point(aes(color = locationGame, shape = typeSeason))+ theme_minimal() +labs(x = "Date") + scale_y_continuous(breaks = seq(0,90,1)) + ggtitle(toupper(paste(params$player,"1st Quarter Rebounds")), subtitle = toupper(paste("Season Avg:", round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + geom_smooth(span = 0.6) + geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16)) + scale_x_date(breaks = "1 month", date_labels = "%b") + facet_grid(~ slugSeason, scales = "free_x")+ guides(color = guide_legend(title = ""),shape = guide_legend(title = ""))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,"1st Quarter Rebounds",'<br>','<sup>',toupper(paste("Current Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))

```



### First Quarter Rebounds by Location

```{r 1q reb boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

metric = "rebounds"


p <- firstq_rebounds %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(locationGame,.data[[metric]], fill = locationGame)) + geom_boxplot() + theme_minimal()+ labs(x = "Location") + ggtitle(toupper(paste(params$player,"regular season",metric,"per game by location"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by location",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```

### First Quarter Rebounds by Weekday

```{r 1q reb boxplot weekday, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


p <- firstq_rebounds %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(day = weekdays(dateGame, abbreviate = TRUE))  %>% ggplot(aes(x=factor(day, levels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),y =.data[[metric]], fill = day)) + geom_boxplot() + theme_minimal()+ labs(x = "Weekday")  + theme(legend.position="none")+ scale_fill_brewer(palette = "RdYlBu")

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"per game by Weekday",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


### First Quarter Rebounds Histogram

```{r 1q reb hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

p <- firstq_rebounds %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% ggplot(aes(.data[[metric]])) + geom_histogram(bins = 6, color = secondary_color, fill = primary_color)+ theme_minimal() + scale_x_continuous(breaks = seq(0,90,1))+ ggtitle(toupper(paste(params$player,"regular season",metric,"histogram")))

ggplotly(p) %>% layout(title = list(text = toupper(paste(params$player,metric,"histogram",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))

```


```{r rebounds probability, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", include = FALSE, eval = FALSE}

reb_over_under_new <- seq(from = 1, to = 9, by = 1)

prob <- sapply(reb_over_under_new, function (x){
  mean(firstq_rebounds %>% filter(slugSeason == current_season, typeseason == "Regular Season") %>% pull(rebounds) >= x)
})

reb <- reb_over_under_new
probability <- prob


df <- data.frame(Rebounds = reb, Probability = round(probability*100,1))

df %>% ggplot(aes(reb,probability)) + geom_point() + scale_y_continuous(breaks = seq(0,1,.1)) + scale_x_continuous(breaks = reb_over_under_new) + ggtitle(toupper(paste(params$player,"1Q Probability of Rebounds"))) + geom_hline(yintercept = 0.5)



```




```{r rebounds probability table, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', fig.width = 9, eval = FALSE}

formattable(df, align = c("c","c"), list(Probability = color_bar(primary_color)))

```

### O/U Probabilities


```{r points hit rate firstq_rebounds, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

player_data_regular <- dat %>% filter(typeSeason == "Regular Season", slugSeason == current_season)

season_avg <- round(avg,0)+0.5

hit_rate <- seq(from = season_avg-3,to = season_avg +3, by =1)

hit_rate_above <- sapply(hit_rate, function(x){
  
  mean(firstq_rebounds %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% pull(rebounds) > x)
  
})

hit_rate_below <- sapply(hit_rate, function(x){

  mean(firstq_rebounds %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% pull(rebounds) <= x)
 
})

df <- data.frame(OU = hit_rate,Over = round(hit_rate_above*100,0), Under = round(hit_rate_below*100,0))

p <- df %>% pivot_longer(cols = !OU, names_to = "type", values_to = "percentage") %>% ggplot(aes(fill = type, x = OU, y = percentage, label = paste0(percentage,"%"))) + geom_bar(position = "stack",stat = "identity") + theme_minimal() + labs(x = "Over/Under", y = "Hit Rate %") + scale_x_continuous(breaks = seq(0.5,50.5,1))+ ggtitle(toupper(paste(params$player,metric,"Over Under Hit Rate %"))) + scale_fill_manual(values = c(primary_color,secondary_color))+ geom_hline(yintercept = 50, color = primary_color, linetype = "dashed") + geom_text(size = 3, position = position_stack(vjust = 0.5))+ guides(fill = guide_legend(title = "")) 


ggplotly(p, tooltip = list("OU","percentage","type")) %>% layout(title = list(text = toupper(paste(params$player,metric,"O/U Probabilities",'<br>','<sup>',toupper("Current Regular Season"),'</sup>'))))


```


Points {data-navmenu="Quarterly Analysis" data-navmenu-icon="fa-diagram-project"}
=======================================================================

Row
-----------------------------------------------------------------------

### Current Regular Season Points per Quarter {data-width=1500}

```{r Quarterly points, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


quarterly_points <-play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason,slugTeam) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugTeam","slugSeason"))

quarterly_points <- replace(quarterly_points,is.na(quarterly_points),0)

p <- quarterly_points %>% select(-slugTeam) %>% mutate(ppg = pts/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% ggplot(aes(numberPeriod,ppg)) + geom_point(size = 5, color = "red", fill = alpha("orange",0.3), alpha = 0.7, stroke = 1)+ geom_segment(aes(x=numberPeriod,xend = numberPeriod, y = 0, yend = ppg), color = "grey")+ theme_minimal() + geom_text(aes(label = round(ppg,1)), position = position_dodge(width = 0.9),vjust = -2) + labs(x = "Quarter", y = "Avg Points") + ggtitle("Avg Points Per Quarter Per Game (OT Excluded)") + scale_y_continuous(breaks = seq(0,50,1)) + scale_color_manual(values = c(primary_color,secondary_color))

ggplotly(p)


```



### Current Regular Season Points per Quarter League Comparison

```{r Quarterly points hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


quarterly_ppg <- quarterly_points  %>% mutate(ppg = pts/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,ppg)

p <- play_play_all %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugTeam","slugSeason")) %>% filter(!is.na(slugTeam), typeSeason == "Regular Season", numberPeriod <= 4,slugSeason == current_season) %>% mutate(ppg = round(pts/n,1)) %>% ggplot(aes(ppg)) +geom_histogram(fill = "orange", bins = 25, color = "grey") + facet_wrap(~numberPeriod, scales = 'free') + theme_minimal() + geom_vline(data = quarterly_ppg, aes(xintercept = ppg, color = "blue"),linetype = "dashed") + theme(legend.position = "none") + scale_x_continuous(breaks = seq(0,20,1)) + ggtitle("Avg Points Per Quarter Per Game Distribution (OT Excluded)")

ggplotly(p)



```



Assists {data-navmenu="Quarterly Analysis"}
=======================================================================


Row
-----------------------------------------------------------------------


### Current Regular Season Assists per Quarter {data-width=1500}

```{r Quarterly assists, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}

  quarterly_assists <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason"))

quarterly_assists <- replace(quarterly_assists,is.na(quarterly_assists),0)


periods <- play_play %>% group_by(numberPeriod) %>% summarize(n = n()) %>% pull(numberPeriod)


quarterly_assists <- lapply(periods, function(x){
  

  
  player_data %>% group_by(idPlayer,namePlayer) %>% summarize(n = n()) %>% mutate(numberPeriod = x, typeSeason = "Regular Season",slugSeason = current_season) %>% rename(namePlayer2 = namePlayer) %>% left_join(quarterly_assists, by = c("idPlayer","numberPeriod","typeSeason","slugSeason")) %>% mutate(assists = replace_na(assists,0)) %>% rename(namePlayer2 = namePlayer2.x) 
  
})

quarterly_assists <- bind_rows(quarterly_assists)



p <- quarterly_assists %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(assists), n = sum(n.y))  %>% mutate(apg = assists/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% ggplot(aes(numberPeriod,apg)) + geom_point(size = 5, color = "green", fill = alpha("orange",0.3), alpha = 0.7, stroke = 1)+ geom_segment(aes(x=numberPeriod,xend = numberPeriod, y = 0, yend = apg), color = "grey")+ theme_minimal() + geom_text(aes(label = round(apg,1)), position = position_dodge(width = 0.9),vjust = -2) + labs(x = "Quarter", y = "Avg Assists") + ggtitle("Avg Assists Per Quarter Per Game (OT Excluded)") + scale_y_continuous(breaks = seq(0,50,1))

ggplotly(p)


```


### Current Regular Season Assists per Quarter League Comparison

```{r Quarterly assists hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


quarterly_apg <- quarterly_assists %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(assists), n = sum(n.y))  %>% mutate(apg = assists/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,apg)

p <- play_play_all_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% filter(!is.na(slugTeam), typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% mutate(apg = round(assists/n,1)) %>% ggplot(aes(apg)) +geom_histogram(fill = "green", bins = 25, color = "grey") + facet_wrap(~numberPeriod, scales = 'free') + theme_minimal() + geom_vline(data = quarterly_apg, aes(xintercept = apg, color = "blue"),linetype = "dashed") + theme(legend.position = "none") + scale_x_continuous(breaks = seq(0,20,1)) + ggtitle("Avg Assists Per Quarter Per Game Distribution (OT Excluded)")

ggplotly(p)

percentile_assists_q1 <- play_play_all_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% filter(!is.na(slugTeam), typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% mutate(apg = round(assists/n,1)) %>% filter(numberPeriod == 1) %>% mutate(percentile = percent_rank(apg)*100) %>% filter(idPlayer == player_id[1]) %>% pull(percentile)


```

Rebounds {data-navmenu="Quarterly Analysis"}
=======================================================================

Row
-----------------------------------------------------------------------

### Current Regular Season Rebounds per Quarter {data-width=1500}

```{r Quarterly rebounds, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


quarterly_rebounds <-play_play_player_rebounds %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason"))

quarterly_rebounds <- replace(quarterly_rebounds,is.na(quarterly_rebounds),0)

p <- quarterly_rebounds %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(reb), n = sum(n))  %>% mutate(rpg = reb/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% ggplot(aes(numberPeriod,rpg)) + geom_point(size = 5, color = "yellow", fill = alpha("orange",0.3), alpha = 0.7, stroke = 1)+ geom_segment(aes(x=numberPeriod,xend = numberPeriod, y = 0, yend = rpg), color = "grey")+ theme_minimal() + geom_text(aes(label = round(rpg,1)), position = position_dodge(width = 0.9),vjust = -2) + labs(x = "Quarter", y = "Avg Rebounds") + ggtitle("Avg Rebounds Per Quarter Per Game (OT Excluded)")+ scale_y_continuous(breaks = seq(0,50,1))

ggplotly(p)


```



### Current Regular Season Rebounds per Quarter League Comparison

```{r Quarterly rebounds hist, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center"}


quarterly_rpg <- quarterly_rebounds  %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(reb), n = sum(n))  %>% mutate(rpg = reb/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,rpg)

p <- play_play_all_rebounds %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% filter(!is.na(slugTeam), typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% mutate(rpg = round(reb/n,1)) %>% ggplot(aes(rpg)) +geom_histogram(fill = "yellow", bins = 25, color = "grey") + facet_wrap(~numberPeriod, scales = 'free') + theme_minimal() + geom_vline(data = quarterly_rpg, aes(xintercept = rpg, color = "blue"),linetype = "dashed") + theme(legend.position = "none") + scale_x_continuous(breaks = seq(0,20,1)) + ggtitle("Avg Rebounds Per Quarter Per Game Distribution (OT Excluded)")

ggplotly(p)

percentile_rebounds_q1 <- play_play_all_rebounds %>% filter(is.na(slugScore)) %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% filter(!is.na(slugTeam), typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% mutate(rpg = round(reb/n,1)) %>% filter(numberPeriod == 1) %>% mutate(percentile = percent_rank(rpg)*100) %>% filter(idPlayer == player_id[1]) %>% pull(percentile)


```



Regular Season Leading Indicators {data-navmenu="Leading Indicator Analysis" data-navmenu-icon="fa-chart-area"}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### First Quarter Leading Indicator - Points

```{r Quarterly points lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}


first <- quarterly_points %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n)) %>% ungroup()  %>% mutate(ppg = pts/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(ppg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

points_prob <- seq(from = round(first,0)+1, to = 50, by = 1)

games <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(pts = sum(pts)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", pts >= first,slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_pts = sum(pts)) %>% mutate(Type = "First Quarter")

games_firstqpts <- games



all <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(pts = sum(pts)) %>% filter(typeSeason == "Regular Season",slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(pts = sum(pts)) %>% mutate(Type = "Total")

all_firstqpts <- all


error <- all %>% mutate(pts = pts*0, Type = "First Quarter") %>% rename(firstq_pts = pts)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(pts = firstq_pts),all %>% semi_join(games, by = "idGame"))



prob <- sapply(points_prob, function(x){
  mean(combined$pts >= x)
})

probability <- prob

df <- data.frame(Points = points_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this total game point total is scored when ",params$player," scores at least ",round(first,1)," points in 1Q: Current Regular Season Only"))

a <- bind %>% filter(Type == "Total")
a_sorted <- a %>% arrange(desc(dateGame))
b <- bind %>% filter(Type == "First Quarter")

a_pts <- round(mean(a$pts),1)

games <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(pts = sum(pts)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", pts < first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_pts = sum(pts)) %>% mutate(Type = "First Quarter")

games_firstqpts_less <- games

error <- all %>% mutate(pts = pts*0, Type = "First Quarter") %>% rename(firstq_pts = pts)
games <- if(nrow(games)==0){error}else{games}


bind <- bind_rows(games %>% rename(pts = firstq_pts),all %>% semi_join(games, by = "idGame"))


a <- bind %>% filter(Type == "Total")
a_sorted <- a %>% arrange(desc(dateGame))
b <- bind %>% filter(Type == "First Quarter")

a_less <- round(mean(a$pts),1)



```



### First Quarter Leading Indicator - Assists

```{r Quarterly assists lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}


quarterly_apg <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(assists), n = sum(n))  %>% mutate(apg = assists/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod, apg)

first <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(assists = sum(assists), n = sum(n))  %>% mutate(apg = assists/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(apg)
zero <- 0

first <- if(length(first) ==0){0}else{first}

assists_prob <- seq(from = round(first,0)+1, to = 15, by = 1)

games <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(assists = sum(assists)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", assists >= first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_assists = sum(assists)) %>% mutate(Type = "First Quarter")

games_firstqast <- games

all <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(assists = sum(assists)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(assists = sum(assists)) %>% mutate(Type = "Total")

all_firstqast <- all

error <- all %>% mutate(assists = assists*0, Type = "First Quarter") %>% rename(firstq_assists = assists)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(assists = firstq_assists),all %>% semi_join(games, by = "idGame"))



prob <- sapply(assists_prob, function(x){
  mean(combined$assists >= x)
})

probability <- prob

df <- data.frame(Assists = assists_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this game assist total happens when ",params$player," has at least ",round(first,1)," assists in 1Q: Current Regular Season Only"))

a <- bind %>% filter(Type == "Total")
a_sorted <- a %>% arrange(desc(dateGame))
b <- bind %>% filter(Type == "First Quarter")

stats <- bind %>% group_by(Type) %>% summarize(mean = mean(assists), SE = sd(assists)) %>% mutate(meanpos = mean + 1 *SE, meanneg = mean - 1*SE)
stats_first <- stats %>% filter(Type == "First Quarter")
stats_total <- stats %>% filter(Type == "Total")

a_ast <- round(mean(a$assists),1)

games <- play_play_player_assists %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(assists = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(assists = sum(assists)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", assists < first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_assists = sum(assists)) %>% mutate(Type = "First Quarter")

games_firstqast_less <- games

error <- all %>% mutate(assists = assists*0, Type = "First Quarter") %>% rename(firstq_assists = assists)
games <- if(nrow(games)==0){error}else{games}


bind <- bind_rows(games %>% rename(assists = firstq_assists),all %>% semi_join(games, by = "idGame"))


a <- bind %>% filter(Type == "Total")
a_sorted <- a %>% arrange(desc(dateGame))
b <- bind %>% filter(Type == "First Quarter")

a_ast_less <- round(mean(a$assists),1)

```




### First Quarter Leading Indicator - Rebounds

```{r Quarterly rebounds lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}


quarterly_rpg <- quarterly_rebounds %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(reb), n = sum(n)) %>% mutate(rpg = reb/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,rpg)

first <- quarterly_rebounds %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(reb = sum(reb), n = sum(n)) %>% mutate(rpg = reb/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(rpg) 
  
zero <- 0

first <- if(length(first) ==0){0}else{first}

reb_prob <- seq(from = round(first,0)+1, to = 15, by = 1)

games <- play_play_player_rebounds %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(reb = sum(n)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", reb >= first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_rebounds = sum(reb)) %>% mutate(Type = "First Quarter")

games_firstqreb <- games

all <- play_play_player_rebounds %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(reb = sum(n)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(reb = sum(reb)) %>% mutate(Type = "Total")

all_firstqreb <- all


error <- all %>% mutate(reb = reb*0, Type = "First Quarter") %>% rename(firstq_rebounds = reb)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(reb = firstq_rebounds),all %>% semi_join(games, by = "idGame"))



prob <- sapply(reb_prob, function(x){
  mean(combined$reb >= x)
})

probability <- prob

df <- data.frame(Rebounds = reb_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this game rebound total happens when ",params$player," has at least ",round(first,1)," rebounds in 1Q: Current Regular Season Only"))

a <- bind %>% filter(Type == "Total")
a_sorted <- a %>% arrange(desc(dateGame))
b <- bind %>% filter(Type == "First Quarter")

a_reb <- round(mean(a$reb),1)

games <- play_play_player_rebounds %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(reb = sum(n)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", reb < first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_rebounds = sum(reb)) %>% mutate(Type = "First Quarter")

games_firstqreb_less <- games

error <- all %>% mutate(reb = reb*0, Type = "First Quarter") %>% rename(firstq_rebounds = reb)
games <- if(nrow(games)==0){error}else{games}


bind <- bind_rows(games %>% rename(reb = firstq_rebounds),all %>% semi_join(games, by = "idGame"))


a <- bind %>% filter(Type == "Total")
a_sorted <- a %>% arrange(desc(dateGame))
b <- bind %>% filter(Type == "First Quarter")

a_reb_less <- round(mean(a$reb),1)

```

### First Quarter Leading Indicator - Steals

```{r Quarterly steals lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}

 quarterly_steals <- play_play_player_steals %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,slugTeamPlayer2,idPlayerNBA1,idPlayerNBA2) %>% rename(slugTeam = slugTeamPlayer2) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(steals = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason"))

quarterly_steals <- replace(quarterly_steals,is.na(quarterly_steals),0)


quarterly_spg <- play_play_player_steals %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2,slugTeamPlayer2) %>% rename(slugTeam = slugTeamPlayer2) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(steals = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(steals = sum(steals), n = sum(n))  %>% mutate(spg = steals/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod, spg)

first <- play_play_player_steals %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2,slugTeamPlayer2) %>% rename(slugTeam = slugTeamPlayer2) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(steals = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(steals = sum(steals), n = sum(n))  %>% mutate(spg = steals/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(spg)
zero <- 0

first <- if(length(first) ==0){0}else{first}

steals_prob <- seq(from = round(first,0)+1, to = 15, by = 1)

games <- play_play_player_steals %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2,slugTeamPlayer2) %>% rename(slugTeam = slugTeamPlayer2) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(steals = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(steals = sum(steals)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", steals >= first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_steals = sum(steals)) %>% mutate(Type = "First Quarter")

games_firstqstl <- games

all <- play_play_player_steals %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2,slugTeamPlayer2) %>% rename(slugTeam = slugTeamPlayer2) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer2,idPlayerNBA2,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(steals = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA2) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(steals = sum(steals)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(steals = sum(steals)) %>% mutate(Type = "Total")

all_firstqstl <- all

error <- all %>% mutate(steals = steals*0, Type = "First Quarter") %>% rename(firstq_steals = steals)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(steals = firstq_steals),all %>% semi_join(games, by = "idGame"))



prob <- sapply(steals_prob, function(x){
  mean(combined$steals >= x)
})

probability <- prob

df <- data.frame(Steals = steals_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this game steal total happens when ",params$player," has at least ",round(first,1)," steals in 1Q: Current Regular Season Only"))


```

### First Quarter Leading Indicator - Blocks

```{r Quarterly blocks lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}

 quarterly_blocks <- play_play_player_blocks %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,namePlayer3,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2,idPlayerNBA3,slugTeamPlayer3) %>% rename(slugTeam = slugTeamPlayer3) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer3,idPlayerNBA3,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(blocks = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA3) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason"))

quarterly_blocks <- replace(quarterly_blocks,is.na(quarterly_blocks),0)


quarterly_bpg <- play_play_player_blocks %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer2,slugTeamPlayer1,idPlayerNBA1,idPlayerNBA2,slugTeamPlayer2,slugTeamPlayer3,namePlayer3,idPlayerNBA3) %>% rename(slugTeam = slugTeamPlayer3) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer3,idPlayerNBA3,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(blocks = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA3) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer3,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(blocks = sum(blocks), n = sum(n))  %>% mutate(bpg = blocks/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod, bpg)

first <- play_play_player_blocks %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer3,slugTeamPlayer3,idPlayerNBA1,idPlayerNBA3) %>% rename(slugTeam = slugTeamPlayer3) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer3,idPlayerNBA3,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(blocks = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA3) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer3,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(blocks = sum(blocks), n = sum(n))  %>% mutate(bpg = blocks/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(bpg)
zero <- 0

first <- if(length(first) ==0){0}else{first}

blocks_prob <- seq(from = round(first,0)+1, to = 15, by = 1)

games <- play_play_player_blocks %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer3,slugTeamPlayer3,idPlayerNBA1,idPlayerNBA3) %>% rename(slugTeam = slugTeamPlayer3) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer3,idPlayerNBA3,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(blocks = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA3) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer3,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(blocks = sum(blocks)) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", blocks >= first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_blocks = sum(blocks)) %>% mutate(Type = "First Quarter")

games_firstqblocks <- games

all <- play_play_player_blocks %>% select(idGame,numberPeriod,descriptionPlayHome,descriptionPlayVisitor, namePlayer1,namePlayer3,slugTeamPlayer3,idPlayerNBA1,idPlayerNBA3) %>% rename(slugTeam = slugTeamPlayer3) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% group_by(namePlayer3,idPlayerNBA3,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(blocks = sum(n)) %>% ungroup() %>% rename(idPlayer = idPlayerNBA3) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugSeason")) %>% group_by(namePlayer3,idPlayer,numberPeriod,typeSeason,slugTeam,dateGame,idGame,slugSeason) %>% summarize(blocks = sum(blocks)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(blocks = sum(blocks)) %>% mutate(Type = "Total")

all_firstqblocks <- all

error <- all %>% mutate(blocks = blocks*0, Type = "First Quarter") %>% rename(firstq_blocks = blocks)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(blocks = firstq_blocks),all %>% semi_join(games, by = "idGame"))



prob <- sapply(blocks_prob, function(x){
  mean(combined$blocks >= x)
})

probability <- prob

df <- data.frame(Blocks = blocks_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this game block total happens when ",params$player," has at least ",round(first,1)," blocks in 1Q: Current Regular Season Only"))


```



### First Quarter Leading Indicator - Three Pointers

```{r Quarterly three points lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}

quarterly_threes <-play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% filter(score_type == "3 pt") %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,slugSeason) %>% summarize(fg3m = n()) %>% ungroup() %>% rename(idPlayer = idPlayerNBA1) %>% left_join(playerdata  %>% group_by(idPlayer,typeSeason,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idPlayer","typeSeason","slugTeam","slugSeason"))

quarterly_threes <- replace(quarterly_threes,is.na(quarterly_threes),0)



quarterly_3pg <- quarterly_threes %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(fg3m = sum(fg3m), n = sum(n))  %>% mutate(threepg = fg3m/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,threepg)

first <- quarterly_threes %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(fg3m = sum(fg3m), n = sum(n))  %>% mutate(threepg = fg3m/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(threepg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

points_prob <- seq(from = round(first,0)+1, to = 8, by = 1)

games <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% filter(score_type == "3 pt") %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(fg3m = n()) %>% filter(numberPeriod == 1, typeSeason == "Regular Season", fg3m >= first, slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(firstq_threes = sum(fg3m)) %>% mutate(Type = "First Quarter")



all <- play_play_player %>% select(idGame,numberPeriod, descriptionPlayHome,descriptionPlayNeutral,descriptionPlayVisitor, namePlayer1,slugScore,scoreHome,scoreAway,slugTeamPlayer1,idPlayerNBA1) %>% rename(slugTeam = slugTeamPlayer1) %>% mutate(description = ifelse(is.na(descriptionPlayHome),ifelse(is.na(descriptionPlayNeutral),descriptionPlayVisitor,descriptionPlayNeutral),descriptionPlayHome)) %>% mutate(free_throw_flag = str_detect(description,"Free Throw"), three_point_flag = str_detect(description,"3PT")) %>% mutate(two_point_flag = ifelse(free_throw_flag == FALSE & three_point_flag == FALSE, TRUE,FALSE)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason,locationGame,slugTeam,slugSeason) %>% summarize(n = n()), by = c("idGame","slugTeam")) %>% mutate(pts = ifelse(free_throw_flag == TRUE,1,ifelse(two_point_flag== TRUE,2,3)),score_type = ifelse(free_throw_flag == TRUE,"Free Throw",ifelse(two_point_flag== TRUE,"2 pt","3 pt"))) %>% filter(score_type == "3 pt") %>% group_by(namePlayer1,idPlayerNBA1,slugTeam,numberPeriod,typeSeason,dateGame,idGame,slugSeason) %>% summarize(fg3m = n()) %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(idGame,dateGame) %>% summarize(fg3m = sum(fg3m)) %>% mutate(Type = "Total")


error <- all %>% mutate(fg3m = fg3m*0, Type = "First Quarter") %>% rename(firstq_threes = fg3m)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(fg3m = firstq_threes),all %>% semi_join(games, by = "idGame"))



prob <- sapply(points_prob, function(x){
  mean(combined$fg3m >= x)
})

probability <- prob

df <- data.frame(Threes = points_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this threes made total is scored when ",params$player," makes at least ",round(first,1)," threes in 1Q: Current Regular Season Only"))

```

Combo Leading Indicators {data-navmenu="Leading Indicator Analysis"}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### First Quarter Leading Indicator - Pts+Reb+Ast

```{r Quarterly ptsrebast points lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}

quarterly_ptsrebast <- quarterly_points %>% left_join(quarterly_rebounds, by = c("idPlayer","typeSeason","slugTeam","numberPeriod","slugSeason")) %>% left_join(quarterly_assists, by = c("idPlayer","typeSeason","slugTeam","numberPeriod","slugSeason")) %>% rename(namePlayer1 = namePlayer1.x) %>% select(namePlayer1,idPlayer,slugTeam,numberPeriod,typeSeason,slugSeason,pts,reb,assists,n.x.x)

quarterly_ptsrebast <- replace(quarterly_ptsrebast,is.na(quarterly_ptsrebast),0)



quarterly_ptsrebastpg <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(ptsrebastpg = (pts+ast+reb)/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,ptsrebastpg)

first <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(ptsrebastpg = (pts+ast+reb)/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(ptsrebastpg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

points_prob <- seq(from = round(first,0)+1, to = 60, by = 1)



games <- games_firstqpts %>% full_join(games_firstqast, by = c("idGame","dateGame","Type")) %>% full_join(games_firstqreb, by = c("idGame","dateGame","Type")) 

games <- replace(games,is.na(games),0)

games <- games %>% mutate(firstq_ptsrebast = firstq_pts + firstq_assists + firstq_rebounds) %>% select(idGame,dateGame,firstq_ptsrebast,Type)


all <- all_firstqpts %>% full_join(all_firstqast, by = c("idGame","dateGame","Type"))  %>% full_join(all_firstqreb, by = c("idGame","dateGame","Type"))  %>% mutate(ptsrebast = replace_na(pts,0) + replace_na(assists,0) + replace_na(reb,0)) %>% select(idGame,dateGame,ptsrebast,Type)


error <- all %>% mutate(ptsrebast = ptsrebast*0, Type = "First Quarter") %>% rename(firstq_ptsrebast = ptsrebast)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(ptsrebast = firstq_ptsrebast),all %>% semi_join(games, by = "idGame"))



prob <- sapply(points_prob, function(x){
  mean(combined$ptsrebast >= x)
})

probability <- prob

df <- data.frame(`Pts+Reb+Ast` = points_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this Pts+Reb+Ast total is attained when ",params$player," has at least ",round(first,1)," Pts+Reb+Ast in 1Q: Current Regular Season Only"))

```

### First Quarter Leading Indicator - Pts+Ast

```{r Quarterly ptsast lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



quarterly_ptsastpg <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(ptsastpg = (pts+ast)/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,ptsastpg)

first <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(ptsastpg = (pts+ast)/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(ptsastpg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

points_prob <- seq(from = round(first,0)+1, to = 60, by = 1)



games <- games_firstqpts %>% full_join(games_firstqast, by = c("idGame","dateGame","Type")) %>% full_join(games_firstqreb, by = c("idGame","dateGame","Type")) 

games <- replace(games,is.na(games),0)

games <- games %>% mutate(firstq_ptsast = firstq_pts + firstq_assists) %>% select(idGame,dateGame,firstq_ptsast,Type)


all <- all_firstqpts %>% full_join(all_firstqast, by = c("idGame","dateGame","Type"))  %>% full_join(all_firstqreb, by = c("idGame","dateGame","Type"))  %>% mutate(ptsast = replace_na(pts,0) + replace_na(assists,0)) %>% select(idGame,dateGame,ptsast,Type)


error <- all %>% mutate(ptsast = ptsast*0, Type = "First Quarter") %>% rename(firstq_ptsast = ptsast)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(ptsast = firstq_ptsast),all %>% semi_join(games, by = "idGame"))



prob <- sapply(points_prob, function(x){
  mean(combined$ptsast >= x)
})

probability <- prob

df <- data.frame(`Pts+Ast` = points_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this Pts+Ast total is attained when ",params$player," has at least ",round(first,1)," Pts+Ast in 1Q: Current Regular Season Only"))

```

### First Quarter Leading Indicator - Pts+Reb

```{r Quarterly ptsreb lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



quarterly_ptsastpg <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(ptsrebpg = (pts+reb)/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,ptsrebpg)

first <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(ptsrebpg = (pts+reb)/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(ptsrebpg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

points_prob <- seq(from = round(first,0)+1, to = 60, by = 1)



games <- games_firstqpts %>% full_join(games_firstqast, by = c("idGame","dateGame","Type")) %>% full_join(games_firstqreb, by = c("idGame","dateGame","Type")) 

games <- replace(games,is.na(games),0)

games <- games %>% mutate(firstq_ptsreb = firstq_pts + firstq_rebounds) %>% select(idGame,dateGame,firstq_ptsreb,Type)


all <- all_firstqpts %>% full_join(all_firstqast, by = c("idGame","dateGame","Type"))  %>% full_join(all_firstqreb, by = c("idGame","dateGame","Type"))  %>% mutate(ptsreb = replace_na(pts,0) + replace_na(reb,0)) %>% select(idGame,dateGame,ptsreb,Type)


error <- all %>% mutate(ptsreb = ptsreb*0, Type = "First Quarter") %>% rename(firstq_ptsreb = ptsreb)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(ptsreb = firstq_ptsreb),all %>% semi_join(games, by = "idGame"))



prob <- sapply(points_prob, function(x){
  mean(combined$ptsreb >= x)
})

probability <- prob

df <- data.frame(`Pts+Reb` = points_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this Pts+Reb total is attained when ",params$player," has at least ",round(first,1)," Pts+Reb in 1Q: Current Regular Season Only"))

```

### First Quarter Leading Indicator - Reb+Ast

```{r Quarterly astreb lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



quarterly_ptsastpg <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(astrebpg = (ast+reb)/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,astrebpg)

first <- quarterly_ptsrebast %>% group_by(namePlayer1,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(pts = sum(pts), n = sum(n.x.x), ast = sum(assists), reb = sum(reb))  %>% mutate(astrebpg = (ast+reb)/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(astrebpg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

points_prob <- seq(from = round(first,0)+1, to = 60, by = 1)



games <- games_firstqpts %>% full_join(games_firstqast, by = c("idGame","dateGame","Type")) %>% full_join(games_firstqreb, by = c("idGame","dateGame","Type")) 

games <- replace(games,is.na(games),0)

games <- games %>% mutate(firstq_astreb = firstq_assists + firstq_rebounds) %>% select(idGame,dateGame,firstq_astreb,Type)


all <- all_firstqpts %>% full_join(all_firstqast, by = c("idGame","dateGame","Type"))  %>% full_join(all_firstqreb, by = c("idGame","dateGame","Type"))  %>% mutate(astreb = replace_na(reb,0) + replace_na(assists,0)) %>% select(idGame,dateGame,astreb,Type)


error <- all %>% mutate(astreb = astreb*0, Type = "First Quarter") %>% rename(firstq_astreb = astreb)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(astreb = firstq_astreb),all %>% semi_join(games, by = "idGame"))



prob <- sapply(points_prob, function(x){
  mean(combined$astreb >= x)
})

probability <- prob

df <- data.frame(`Reb+Ast` = points_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this Reb+Ast total is attained when ",params$player," has at least ",round(first,1)," Reb+Ast in 1Q: Current Regular Season Only"))

```

### First Quarter Leading Indicator - Stl+Blk

```{r Quarterly stlnlk lead, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}


quarterly_stlblk <- quarterly_steals %>% left_join(quarterly_blocks, by = c("idPlayer","slugTeam","numberPeriod","typeSeason","slugSeason")) %>% select(namePlayer2,idPlayer,slugTeam,numberPeriod,typeSeason,slugSeason,steals,blocks,n.x)

quarterly_stlblk <- replace(quarterly_stlblk, is.na(quarterly_stlblk),0)


quarterly_stlblkpg <- quarterly_stlblk %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(blk = sum(blocks), n = sum(n.x), stl = sum(steals))  %>% mutate(stlblkpg = (stl+blk)/n) %>% filter(typeSeason == "Regular Season", numberPeriod <= 4, slugSeason == current_season) %>% select(numberPeriod,stlblkpg)

first <- quarterly_stlblk %>% group_by(namePlayer2,idPlayer,numberPeriod,typeSeason,slugSeason) %>% summarize(blk = sum(blocks), n = sum(n.x), stl = sum(steals))  %>% mutate(stlblkpg = (stl+blk)/n) %>% filter(typeSeason == "Regular Season", numberPeriod == 1, slugSeason == current_season) %>% pull(stlblkpg)
zero <- 0
first <- if(length(first) ==0){0}else{first}

stlblk_prob <- seq(from = round(first,0)+1, to = 10, by = 1)



games <- games_firstqstl %>% full_join(games_firstqblocks, by = c("idGame","dateGame","Type"))

games <- replace(games,is.na(games),0)

games <- games %>% mutate(firstq_stlblk = firstq_steals + firstq_blocks) %>% select(idGame,dateGame,firstq_stlblk,Type)


all <- all_firstqstl %>% full_join(all_firstqblocks, by = c("idGame","dateGame","Type"))%>% mutate(stlblk = replace_na(steals,0) + replace_na(blocks,0)) %>% select(idGame,dateGame,stlblk,Type)


error <- all %>% mutate(stlblk = stlblk*0, Type = "First Quarter") %>% rename(firstq_stlblk = stlblk)
games <- if(nrow(games)==0){error}else{games}

combined <- games %>% left_join(all, by = "idGame")


bind <- bind_rows(games %>% rename(stlblk = firstq_stlblk),all %>% semi_join(games, by = "idGame"))



prob <- sapply(stlblk_prob, function(x){
  mean(combined$stlblk >= x)
})

probability <- prob

df <- data.frame(`Stl+Blk` = stlblk_prob, Probability = round(probability*100,1))

formattable(df, align = c("c","c"), list(Probability = color_bar("orange")), caption = paste("Likelihood that this Stl+Blk total is attained when ",params$player," has at least ",round(first,1)," Stl+Blk in 1Q: Current Regular Season Only"))

```



Data by Opponent {data-navmenu="Splits" data-navmenu-icon="fa-chart-gantt"}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Opponent Summary - Regular Season

```{r Season Opponents, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_opponent_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

formattable(season_opponent_table, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```

### Opponent Summary - Regular Season Home Games

```{r Season Opponents Home, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}

season_opponent_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,locationGame == "H") %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

formattable(season_opponent_table, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")


```


### Opponent Summary - Regular Season Away Games

```{r Season Opponents Away, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}

season_opponent_table_away <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,locationGame == "A") %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

formattable(season_opponent_table_away, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")


```


Data by Result {data-navmenu="Splits" data-navmenu-icon="fa-chart-gantt"}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Wins - Regular Season

```{r Season Wins, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_wins_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,outcomeGame == "W") %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

formattable(season_wins_table, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```

### Losses - Regular Season

```{r Season Losses, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_losses_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,outcomeGame == "L") %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

formattable(season_losses_table, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```


Data by Rest {data-navmenu="Splits" data-navmenu-icon="fa-chart-gantt"}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### 0 Days Rest - Regular Season

```{r Season zero, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_zero_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,countDaysRestPlayer == 0) %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

names <- colnames(season_zero_table)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_zero_table))*0)), nrow = 1, ncol=ncol(season_zero_table)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_zero_table_frame <- if(nrow(season_zero_table)==0){error}else{season_zero_table}

formattable(season_zero_table_frame, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```


### 1 Day Rest - Regular Season

```{r Season one, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_one_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,countDaysRestPlayer == 1) %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

names <- colnames(season_one_table)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_one_table))*0)), nrow = 1, ncol=ncol(season_one_table)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_one_table_frame <- if(nrow(season_one_table)==0){error}else{season_one_table}

formattable(season_one_table_frame, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```

### 2 Days Rest - Regular Season

```{r Season two, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_two_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,countDaysRestPlayer == 2) %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

names <- colnames(season_two_table)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_one_table))*0)), nrow = 1, ncol=ncol(season_two_table)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_two_table_frame <- if(nrow(season_two_table)==0){error}else{season_two_table}

formattable(season_two_table_frame, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```


### 3 Days Rest - Regular Season

```{r Season three, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_three_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% filter(typeSeason == "Regular Season", slugSeason == current_season,countDaysRestPlayer >=3) %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

names <- colnames(season_three_table)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_three_table))*0)), nrow = 1, ncol=ncol(season_three_table)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_three_table_frame <- if(nrow(season_three_table)==0){error}else{season_three_table}

formattable(season_three_table_frame, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```



Data by Conference {data-navmenu="Splits" data-navmenu-icon="fa-chart-gantt"}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Against Western Conference Opponents - Regular Season

```{r Season western, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_western_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% left_join(conference %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season", slugSeason == current_season, nameConference == "Western") %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

names <- colnames(season_western_table)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_western_table))*0)), nrow = 1, ncol=ncol(season_western_table)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_western_table_frame <- if(nrow(season_western_table)==0){error}else{season_western_table}

formattable(season_western_table_frame, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```

### Against Eastern Conference Opponents - Regular Season

```{r Season eastern, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE}



season_eastern_table <- player_data %>% left_join(play_play_rebounds %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqrebounds = n()), by = "idGame") %>% mutate(firstqrebounds = replace_na(firstqrebounds,0)) %>% left_join(play_play_assists %>% filter(numberPeriod == 1) %>% group_by(idGame) %>% summarize(firstqassists = n()), by = "idGame") %>% mutate(firstqassists = replace_na(firstqassists,0)) %>% left_join(play_play_makes %>% filter(numberPeriod == 1) %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n(),firstqpoints = sum(pts)) %>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame) %>% summarize(firstqpoints = sum(firstqpoints)), by = "idGame") %>% mutate(firstqpoints = replace_na(firstqpoints,0)) %>% left_join(play_play_makes %>% group_by(idGame,namePlayer1,slugScore,scoreHome,scoreAway,score_type) %>% summarize(n = n()) %>% mutate(first = ifelse((scoreHome >0 & scoreAway == 0) | (scoreAway > 0 & scoreHome == 0),1,0))%>% left_join(gamedata %>% group_by(idGame,dateGame,typeSeason) %>% summarize(n = n()), by = "idGame") %>% group_by(idGame,first) %>% summarize(n = n()) %>% filter(first == 1), by = "idGame") %>% mutate(first = replace_na((first),0)) %>% left_join(conference %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season", slugSeason == current_season, nameConference == "Eastern") %>% mutate(opponent = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% group_by(dateGame,opponent) %>% summarize(n = n(), total_pts = sum(pts), total_reb = sum(treb), total_ast = sum(ast), total_stl = sum(stl), total_blk = sum(blk), total_fgm = sum(fgm), total_fga = sum(fga), total_fg3m = sum(fg3m), total_minutes = sum(minutes), total_tov = sum(tov), total_first = sum(first), totalfqpts = sum(firstqpoints), totalfqast = sum(firstqassists), totalfqtreb = sum(firstqrebounds), totalftm = sum(ftm), total_fg3a = sum(fg3a))  %>% mutate(ppg = round(total_pts/n,1), rpg = round(total_reb/n,1), apg = round(total_ast/n,1), spg = round(total_stl/n,1), bpg = round(total_blk/n,1), fg_percentage = round((total_fgm/total_fga)*100,1), fg3_percentage = round((total_fg3m/total_fg3a)*100,1), min = round(total_minutes/n,1),threepg = round(total_fg3m/n,1),threeattempt = round(total_fg3a/n,1), tovpg = round(total_tov/n,1), pts_ast = round((total_pts+total_ast)/n,1), pts_reb_ast = round((total_reb+total_pts+total_ast)/n,1), pts_reb = round((total_pts+total_reb)/n,1), ast_reb = round((total_ast+total_reb)/n,1),firstqppg = round(totalfqpts/n,1), firstqapg = round(totalfqast/n,1), firstqrpg = round(totalfqtreb/n,1), pts_per_attempt = round(total_pts/total_fga,2), ftmpg = round(totalftm/n,1),stl_blk = round((total_blk+total_stl)/n,1), fgapg = round(total_fga/n,1),fgmpg = round(total_fgm/n,1) ) %>% select(dateGame,opponent,n,min,ppg,rpg,apg,spg,bpg,threepg,threeattempt,fg_percentage,fgmpg,fgapg,fg3_percentage,ftmpg,tovpg, pts_reb_ast, pts_ast,pts_reb,ast_reb,stl_blk, total_first,firstqppg,firstqapg,firstqrpg, pts_per_attempt) %>%
  rename(GP = n,
        Opponent = opponent, 
        Min = min,
         PPG = ppg,
         RPG = rpg,
         APG = apg,
         SPG = spg,
         BPG = bpg,
         TOV = tovpg,
         FGM = fgmpg,
         FGA = fgapg,
         FG3M = threepg,
         FG3A = threeattempt,
         FTM = ftmpg,
         `FG%` = fg_percentage,
         `3FG%` = fg3_percentage,
         `Pts+Reb+Ast` = pts_reb_ast,
         `Pts+Ast` = pts_ast,
         `Pts+Reb` = pts_reb,
         `Reb+Ast` = ast_reb,
         `Stl+Blk` = stl_blk,
         `First Scorer Count` = total_first,
         `Q1 PPG` = firstqppg,
         `Q1 APG` = firstqapg,
         `Q1 RPG` = firstqrpg,
         `Pts Per Attempt` = pts_per_attempt,
        Date = dateGame) 

names <- colnames(season_eastern_table)
error <- as.data.frame(matrix(c(player_name[1], as.integer(seq(1:ncol(season_eastern_table))*0)), nrow = 1, ncol=ncol(season_eastern_table)))
colnames(error) <- names
error[, -1] <- sapply(error[, -1], as.numeric)
season_eastern_table_frame <- if(nrow(season_eastern_table)==0){error}else{season_eastern_table}

formattable(season_eastern_table_frame, align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"),RPG = color_tile("white","gold"),APG = color_tile("white","gold"),SPG = color_tile("white","gold"),BPG = color_tile("white","gold"),TOV = color_tile("white","gold"),FGM = color_tile("white","gold"),FGA = color_tile("white","gold"),FG3M = color_tile("white","gold"),FG3A = color_tile("white","gold"),FTM = color_tile("white","gold"),`FG%` = color_tile("white","gold"),`3FG%`= color_tile("white","gold"), `Pts+Reb+Ast` = color_tile("white","gold"), `Pts+Ast` = color_tile("white","gold"), `Pts+Reb` = color_tile("white","gold"), `Reb+Ast` = color_tile("white","gold"),`Stl+Blk` = color_tile("white","gold"), `First Scorer Count` = color_tile("white","gold"), `Q1 PPG` = color_tile("white","gold"), `Q1 APG` = color_tile("white","gold"), `Q1 RPG` = color_tile("white","gold"), `Pts Per Attempt` = color_tile("white","gold")), caption = "Against Opponents: Current Regular Season")



```



Geographic Analysis {.hidden}
=======================================================================

Column {data-width=1500}
-----------------------------------------------------------------------

### PPG by City Played

```{r map, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, error = TRUE, eval = FALSE}

lat_long <- read.csv("NBA_Lat_Long.csv")
lat_long <- lat_long %>% rename(nameTeam = Team)

ppg <- player_data %>% filter(typeSeason == "Regular Season", locationGame == "A") %>% group_by(slugOpponent) %>% summarize(pts = sum(pts), n = n()) %>% mutate(ppg = pts /n) %>% rename(slugTeam = slugOpponent) %>% select(slugTeam, ppg)

cities <- as.data.frame(gamedata %>% group_by(nameTeam,slugTeam) %>% summarize(n = n()) %>% left_join(lat_long, by = "nameTeam") %>% right_join(ppg, by = "slugTeam") %>% rename(z = ppg,lat = Lat, lon = Long)) %>% mutate(z = round(z,0)) %>% select(slugTeam,lat,lon,z)


hcmap("countries/us/custom/us-all-mainland", showInLegend = FALSE) |> 
  hc_add_series(
  data = cities,
  value = "z",
  type = "mapbubble",
  name = "PPG",
  minSize = 0.5,
  maxSize = "5%",
  color = primary_color,
  borderWidth = 0.1,
  tooltip = list(
    valueDecimals = 1,
    pointFormat = "{point.slugTeam}{point.z}"
  )
) |> hc_mapNavigation(enabled = TRUE) |> hc_title(text = "PPG by City") |> hc_subtitle(text = "Regular Season Away Games")


```

Column 
-----------------------------------------------------------------------

### PPG Regular Season Away Games

```{r Season Opponents Away Summary, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, eval = FALSE}



formattable(season_opponent_table_away %>% select(Opponent,GP,Min,PPG) %>% arrange(desc(PPG)), align = "c", list(Min = color_tile("white","gold"),PPG = color_tile("white","gold"), caption = "Against Opponents: Regular Season"))


```

Defensive Rating Analysis {.hidden}
=======================================================================

Column {.tabset .tabset-fade .tabset-pills}
-----------------------------------------------------------------------

### Points Per Game

```{r defensive rating, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

library(ggrepel)
library(ggimage)



metric = "pts"

rating <- suppressWarnings(suppressPackageStartupMessages(suppressMessages(unnest(bref_teams_stats(seasons = 2025, return_message = FALSE)))))

rating <- rating %>% mutate(OppPoss = .5 *(fgaTotalsOpponent + .475* ftaTotalsOpponent-orbTotalsOpponent+tovTotalsOpponent), tmPoss = .5 *(fgaTotalsTeam + .475* ftaTotalsTeam-orbTotalsTeam+tovTotalsTeam)) %>% select(idTeamNBA,nameTeam,slugTeamBREF,nameConference,OppPoss,ptsTotalsOpponent,tmPoss) %>% mutate(defrtg = round(100/(tmPoss+OppPoss) * ptsTotalsOpponent,2)) 

rating$slugTeamBREF <- replace(rating$slugTeamBREF, rating$slugTeamBREF %in% c("CHO","PHO","BRK"),c("CHA","PHX","BKN"))



table <- player_data %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pts = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(pts ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average PPG decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average PPG increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on PPG")
  }
}


#p <- player_data %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference,urlThumbnailTeam) %>% summarize(pts = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg)) %>% ggplot(aes(x = defrtg,y = pts)) + geom_point() + theme_minimal()  + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "ppg", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)") + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1)

p <- player_data %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(pts = mean(pts)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "PPG", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p




```




### Assists Per Game 

```{r defensive rating ast, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "ast"

table <- player_data %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(ast = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(ast ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average APG decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average APG increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on APG")
  }
}


p <- player_data %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(ast = mean(ast)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "APG", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```



### Rebounds Per Game

```{r defensive rating treb, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "treb"

table <- player_data %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(reb = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(reb ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average RPG decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average RPG increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on RPG")
  }
}




p <- player_data %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(treb = mean(treb)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "RPG", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```


### Three Pointers Made

```{r defensive rating fg3m, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "fg3m"

table <- player_data %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(fg3m = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(fg3m ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average FG3M per game decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average FG3M per game increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on FG3M per game")
  }
}




p <- player_data %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(fg3m = mean(fg3m)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "FG3M", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```


### Turnovers Per Game

```{r defensive rating tov, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "tov"

table <- player_data %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(tov = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(tov ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average TOV per game decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average TOV per game increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on TOV per game")
  }
}




p <- player_data %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(tov = mean(tov)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "TOV", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```

### Pts+Reb+Ast

```{r defensive rating pt+reb+ast, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

dat <- playerdata %>% filter(idPlayer == player_id[1]) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_ast_total = pts+treb+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_ast_total,typeSeason,slugOpponent) 

table <- dat %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pt_reb_ast = mean(pt_reb_ast_total), n = n(), defrtg = mean(defrtg))

fit <- lm(pt_reb_ast ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average Pts+Reb+Ast per game decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average Pts+Reb+Ast per game increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on Pts+Reb+Ast per game")
  }
}




p <- dat %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(pt_reb_ast = mean(pt_reb_ast_total)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,"Pts+Reb+Ast","Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Pts+Reb+Ast", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```


### Pts+Ast

```{r defensive rating pt+ast, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_ast_total = pts+ast) %>% select(dateGame,locationGame,pts,treb,ast,pt_ast_total,typeSeason,slugOpponent)

table <- dat %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pt_ast = mean(pt_ast_total), n = n(), defrtg = mean(defrtg))

fit <- lm(pt_ast ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average Pts+Ast per game decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average Pts+Ast per game increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on Pts+Ast per game")
  }
}




p <- dat %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(pt_ast = mean(pt_ast_total)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,"Pts+Ast","Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Pts+Ast", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```

### Pts+Reb

```{r defensive rating pt+reb, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),pt_reb_total = pts+treb) %>% select(dateGame,locationGame,pts,treb,ast,pt_reb_total,typeSeason,slugOpponent)

table <- dat %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pt_reb = mean(pt_reb_total), n = n(), defrtg = mean(defrtg))

fit <- lm(pt_reb ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average Pts+Reb per game decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average Pts+Reb per game increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on Pts+Reb per game")
  }
}




p <- dat %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(pt_reb = mean(pt_reb_total)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,"Pts+Reb","Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Pts+Reb", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```

### Reb+Ast

```{r defensive rating reb_ast, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

dat <- playerdata %>% filter(idPlayer == player_id) %>% 
  select(dateGame, idGame, slugOpponent, idPlayer, namePlayer, fgm,fga,pts,treb,ast,stl,blk,fg3m,fg3a,tov,
         plusminus,minutes,locationGame, countDaysRestPlayer, isB2B, isB2BFirst, isB2BSecond,typeSeason) %>% 
  arrange(desc(dateGame)) %>% mutate(tripdoub = ifelse(pts >= 10 & treb >= 10 & ast >= 10, "Y","N"),reb_ast_total = ast+treb) %>% select(dateGame,locationGame,pts,treb,ast,reb_ast_total,typeSeason,slugOpponent) 

table <- dat %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(reb_ast = mean(reb_ast_total), n = n(), defrtg = mean(defrtg))

fit <- lm(reb_ast ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0.1){
  paste("Using Linear Regression, as opp defensive rating improves by 1, on average Reb+Ast per game decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] <= -0.1){
    paste("Using Linear Regression, as opp defensive rating improves by 1, on average Reb+Ast per game increases by",abs(coef))
  }
  else{
    paste("Using Linear Regression, changes in defensive rating have little to no impact on Reb+Ast per game")
  }
}




p <- dat %>% left_join(logos %>% rename(slugOpponent = slugTeam), by = "slugOpponent") %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,urlThumbnailTeam) %>% summarize(reb_ast = mean(reb_ast_total)) %>% pivot_longer(!c(slugOpponent,urlThumbnailTeam), names_to = "cat", values_to = "metric") %>% left_join(rating %>% select(slugTeamBREF,defrtg) %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% ggplot(aes(x = defrtg, y = metric)) + geom_point(alpha = 0.1) + theme_minimal() + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) +geom_image(aes(image = urlThumbnailTeam), size = 0.1) + ggtitle(toupper(paste(params$player,"Reb+Ast","Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Reb+Ast", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)")



p

```



Defensive Rating Analysis: Q1 PPG {.hidden}
=======================================================================

Column {.tabset .tabset-fade data-width=1500}
-----------------------------------------------------------------------

### Q1 Pts Per Game vs Opponent Defensive Rating

```{r defensive rating q1 ppg, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "pts"

table <- firstq_makes %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pts = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(pts ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0){
  paste("Using Linear Regression, as opp defensive rating improves, on average PPG decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] ==0){
    paste("Using Linear Regression, as opp defensive rating improves, on average PPG remains unchanged")
  }
  else{
    paste("Using Linear Regression, as opp defensive rating improves, on average PPG increases by",abs(coef))
  }
}


p <- firstq_makes %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pts = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg)) %>% ggplot(aes(x = defrtg, y = pts, label = slugOpponent)) + geom_point() + theme_minimal() +geom_text_repel(size = 3, hjust = 1.5) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Q1 PPG", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)") + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) 

p 

```


Column 
-----------------------------------------------------------------------

### Summary

```{r defensive rating summary q1 ppg, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, eval = FALSE}


rating_table <- firstq_makes %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(pts = round(mean(.data[[metric]]),1), defrtg = round(mean(defrtg),1)) %>% rename(Opponent = slugOpponent, Conference = nameConference, `Q1 PPG` = pts, `Defensive Rating` = defrtg)


formattable(rating_table %>% arrange(desc(`Defensive Rating`)), align = "c", list(`Q1 PPG` = color_tile("white","gold"),`Defensive Rating` = color_tile("white","gold"), caption = "Against Opponents: Regular Season"))


```


Defensive Rating Analysis: Q1 APG {.hidden}
=======================================================================

Column {.tabset .tabset-fade data-width=1500}
-----------------------------------------------------------------------

### Q1 Ast Per Game vs Opponent Defensive Rating

```{r defensive rating q1 apg, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "ast"

table <- firstq_assists %>% rename(ast = assists) %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(ast = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(ast ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0){
  paste("Using Linear Regression, as opp defensive rating improves, on average PPG decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] ==0){
    paste("Using Linear Regression, as opp defensive rating improves, on average PPG remains unchanged")
  }
  else{
    paste("Using Linear Regression, as opp defensive rating improves, on average PPG increases by",abs(coef))
  }
}


p <- firstq_assists %>% rename(ast = assists) %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(ast = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg)) %>% ggplot(aes(x = defrtg, y = ast, label = slugOpponent)) + geom_point() + theme_minimal() +geom_text_repel(size = 3, hjust = 1.5) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Q1 APG", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)") + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) 

p 

```

Column 
-----------------------------------------------------------------------

### Summary

```{r defensive rating summary q1 apg, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, eval = FALSE}


rating_table <- firstq_assists %>% rename(ast = assists) %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(ast = round(mean(.data[[metric]]),1), defrtg = round(mean(defrtg),1)) %>% rename(Opponent = slugOpponent, Conference = nameConference, `Q1 APG` = ast, `Defensive Rating` = defrtg)


formattable(rating_table %>% arrange(desc(`Defensive Rating`)), align = "c", list(`Q1 APG` = color_tile("white","gold"),`Defensive Rating` = color_tile("white","gold"), caption = "Against Opponents: Regular Season"))


```


Defensive Rating Analysis: Q1 RPG {.hidden}
=======================================================================

Column {.tabset .tabset-fade data-width=1500}
-----------------------------------------------------------------------

### Q1 Reb Per Game vs Opponent Defensive Rating

```{r defensive rating q1 rpg, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, fig.width = 9, results = 'hide', eval = FALSE}

metric = "treb"

table <- firstq_rebounds %>% rename(treb = rebounds) %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(reb = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg))

fit <- lm(reb ~ defrtg , data = table)

coef <- round(summary(fit)$coefficients[2,1],2)

message <- if(summary(fit)$coefficients[2,1] >=0){
  paste("Using Linear Regression, as opp defensive rating improves, on average PPG decreases by",abs(coef))
}else{
  if(summary(fit)$coefficients[2,1] ==0){
    paste("Using Linear Regression, as opp defensive rating improves, on average PPG remains unchanged")
  }
  else{
    paste("Using Linear Regression, as opp defensive rating improves, on average PPG increases by",abs(coef))
  }
}


p <- firstq_rebounds %>% rename(treb = rebounds) %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(reb = mean(.data[[metric]]), n = n(), defrtg = mean(defrtg)) %>% ggplot(aes(x = defrtg, y = reb, label = slugOpponent)) + geom_point() + theme_minimal() +geom_text_repel(size = 3, hjust = 1.5) + ggtitle(toupper(paste(params$player,metric,"Per Game vs Opponent Defensive Rating")), subtitle = message) + labs(x = "Defensive Rating", y = "Q1 RPG", caption = "Defensive Rating = 100/(TmPoss + OppPoss) * Opp Pts // Poss = .5*(FGA+.475*FTA-ORB+TOV)") + geom_smooth(method = "lm", se = FALSE, linetype = "dashed") + scale_x_reverse(breaks = seq(100,200,1)) 

p 

```

Column 
-----------------------------------------------------------------------

### Summary

```{r defensive rating summary q1 rpg, echo = FALSE, warning = FALSE, message = FALSE, fig.align='center', error = TRUE, eval = FALSE}


rating_table <- firstq_rebounds %>% rename(treb = rebounds) %>% left_join(rating %>% rename(slugOpponent = slugTeamBREF), by = c("slugOpponent")) %>% filter(typeSeason == "Regular Season") %>% group_by(slugOpponent,nameConference) %>% summarize(reb = round(mean(.data[[metric]]),1), defrtg = round(mean(defrtg),1)) %>% rename(Opponent = slugOpponent, Conference = nameConference, `Q1 RPG` = reb, `Defensive Rating` = defrtg)


formattable(rating_table %>% arrange(desc(`Defensive Rating`)), align = "c", list(`Q1 RPG` = color_tile("white","gold"),`Defensive Rating` = color_tile("white","gold"), caption = "Against Opponents: Regular Season"))


```







Points { .hidden}
=======================================================================

Column 
-----------------------------------------------------------------------

### Points Per Game

```{r Exploratory PPG b2b, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

metric = "pts"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE) %>% pull(metric))

p <- player_data %>% filter(isB2BSecond == TRUE) %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Number of Games:",nrow(player_data %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE)),"/ Season Avg:",round(avg,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16))

ggplotly(p) %>% layout(legend = list(orientation = "h"))

```

Column 
-----------------------------------------------------------------------

### Second Night of B2B Points

```{r b2b pts boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

metric = "pts"


p <- player_data %>% ggplot(aes(isB2BSecond,.data[[metric]], fill = isB2BSecond)) + geom_boxplot() + theme_minimal()+ labs(x = "2nd Night of Back to Back") + ggtitle(toupper(paste(params$player,metric,"per game by B2B"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p)

```

Assists { .hidden}
=======================================================================

Column 
-----------------------------------------------------------------------

### Assists Per Game

```{r Exploratory APG b2b, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

metric = "ast"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE) %>% pull(metric))

p <- player_data %>% filter(isB2BSecond == TRUE) %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Number of Games:",nrow(player_data %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE)),"/ Season Avg:",round(avg,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16))

ggplotly(p) %>% layout(legend = list(orientation = "h"))

```

Column 
-----------------------------------------------------------------------

### Second Night of B2B Assists

```{r b2b ast boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

metric = "ast"


p <- player_data %>% ggplot(aes(isB2BSecond,.data[[metric]], fill = isB2BSecond)) + geom_boxplot() + theme_minimal()+ labs(x = "2nd Night of Back to Back") + ggtitle(toupper(paste(params$player,metric,"per game by B2B"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p)

```


Rebounds { .hidden}
=======================================================================

Column 
-----------------------------------------------------------------------

### Rebounds Per Game

```{r Exploratory RPG b2b, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

metric = "treb"

avg <- mean(player_data %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE) %>% pull(metric))

p <- player_data %>% filter(isB2BSecond == TRUE) %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + theme_minimal() + labs(x = "Date") + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Number of Games:",nrow(player_data %>% filter(typeSeason == "Regular Season", isB2BSecond == TRUE)),"/ Season Avg:",round(avg,1))))+ geom_hline(yintercept = avg) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16))

ggplotly(p) %>% layout(legend = list(orientation = "h"))

```


Column 
-----------------------------------------------------------------------

### Second Night of B2B Rebounds

```{r b2b reb boxplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}

metric = "treb"



p <- player_data %>% ggplot(aes(isB2BSecond,.data[[metric]], fill = isB2BSecond)) + geom_boxplot() + theme_minimal()+ labs(x = "2nd Night of Back to Back") + ggtitle(toupper(paste(params$player,metric,"per game by B2B"))) + theme(legend.position="none") + scale_fill_manual(values = c(primary_color,secondary_color))

ggplotly(p)

```


Points in the Paint {.hidden}
=======================================================================


### Points in the Paint

```{r Exploratory Points in the Paint, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE, eval = FALSE}

t <- readRDS("C:/Users/CECRAIG/Documents/NBA/boxscores.rds")

player_data_advanced <- t %>% filter(idTeam == team_id, idPlayer == player_id) %>% left_join(gamedata %>% filter(idTeam == team_id[1]) %>% group_by(idGame,locationGame,typeSeason, dateGame, slugOpponent) %>% summarize(n = n()), by = "idGame")

player_data_advanced_expanded <- t %>% filter(idTeam == team_id[1]) %>% left_join(gamedata %>% filter(idTeam == team_id) %>% group_by(idGame,locationGame,typeSeason, dateGame, slugOpponent) %>% summarize(n = n()), by = "idGame")

metric = "ptsPaint"

avg_ptspaint <- mean(player_data_advanced %>% filter(typeSeason == "Regular Season") %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% pull(metric))
avg_lastx_ptspaint <- mean(player_data_advanced %>% arrange(desc(dateGame)) %>% head(params$games) %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% pull(metric))

p <- player_data_advanced %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date")  + scale_y_continuous(breaks = seq(0,90,1)) + geom_hline(yintercept = avg_ptspaint) + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg_ptspaint,1),"/","Avg Last",params$games,"games:",round(avg_lastx_ptspaint,1)))) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16))


ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Season Avg:",round(avg_ptspaint,1),"/","Avg Last",params$games,"games:",round(avg_lastx_ptspaint,1))),'</sup>'))))

```



```{r Exploratory Points in the Paint Rank, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE}


player_data_advanced_expanded %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% filter(typeSeason == "Regular Season") %>% group_by(namePlayer,idPlayer) %>% summarize(ptsPaint = sum(ptsPaint),ptsFastBreak = sum(ptsFastBreak), GP = n()) %>% ungroup() %>% mutate(rank = order(order(ptsPaint, decreasing = T))) %>% mutate(axis = paste0(namePlayer," (", rank,")")) %>% ggplot(aes(x = reorder(axis,ptsPaint),y = ptsPaint, fill = ifelse(namePlayer == params$player,"high","default"))) + geom_bar(stat = "identity") + coord_flip() + theme_minimal() + labs(x = "Player (Team Rank)", y = "Points in the Paint") + ggtitle("Regular Season Points in the Paint") + geom_text(aes(label = ptsPaint), position = position_dodge(width = 0.9),hjust = -0.25) + scale_fill_manual(values = c(high = primary_color, default = "grey45")) + guides(fill = FALSE)

pts_paint_rank <- player_data_advanced_expanded %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% filter(typeSeason == "Regular Season") %>% group_by(idPlayer,namePlayer) %>% summarize(ptsPaint = sum(ptsPaint)) %>% ungroup() %>% mutate(rank = rank(-ptsPaint)) %>% filter(idPlayer == player_id[1]) %>% pull(rank)




```

Fast Break Points {.hidden}
=======================================================================

### Fast Break Points

```{r Exploratory Fast Break Points, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE, error = TRUE}


metric = "ptsFastBreak"

avg <- mean(player_data_advanced %>% filter(typeSeason == "Regular Season") %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% pull(metric))
avg_lastx <- mean(player_data_advanced %>% arrange(desc(dateGame)) %>% head(params$games) %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% pull(metric))

p <- player_data_advanced %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date")  + scale_y_continuous(breaks = seq(0,90,1)) + geom_hline(yintercept = avg) + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1)))) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Season Avg:",round(avg,1),"/","Avg Last",params$games,"games:",round(avg_lastx,1))),'</sup>'))))


```



```{r Exploratory Fast Break Points Rank, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE, error = TRUE}


player_data_advanced_expanded %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% filter(typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(ptsPaint = sum(ptsPaint),ptsFastBreak = sum(ptsFastBreak), GP = n()) %>% mutate(rank = order(order(ptsFastBreak, decreasing = T))) %>% mutate(axis = paste0(namePlayer," (", rank,")")) %>% ggplot(aes(x = reorder(axis,ptsFastBreak),y = ptsFastBreak, fill = ifelse(namePlayer == params$player,"high","default"))) + geom_bar(stat = "identity") + coord_flip() + theme_minimal() + labs(x = "Player (Team Rank)", y = "Fast Break Points") + ggtitle("Regular Season Fast Break Points") + geom_text(aes(label = ptsFastBreak), position = position_dodge(width = 0.9),hjust = -0.25) + scale_fill_manual(values = c(high = primary_color, default = "grey45")) + guides(fill = FALSE)




```

Possessions {.hidden}
=======================================================================



```{r Exploratory Possessions, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE, error = TRUE}


metric = "possessions"

avg_pos <- mean(player_data_advanced %>% filter(typeSeason == "Regular Season") %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% pull(metric))
avg_lastx_pos <- mean(player_data_advanced %>% arrange(desc(dateGame)) %>% head(params$games) %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% pull(metric))

p <- player_data_advanced %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% ggplot(aes(dateGame,.data[[metric]], label = slugOpponent)) +geom_line() + geom_point(aes(color = locationGame, shape = typeSeason)) + geom_smooth(span = 0.6) + theme_minimal() + labs(x = "Date")  + geom_hline(yintercept = avg_pos) + ggtitle(toupper(paste(params$player,metric,"Per Game")), subtitle = toupper(paste("Season Avg:",round(avg_pos,1),"/","Avg Last",params$games,"games:",round(avg_lastx_pos,1)))) + scale_color_manual(values = c(primary_color,secondary_color))+ scale_shape_manual(values = c(15,16))

ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0, y = -0.2), 
                       title = list(text = toupper(paste(params$player,metric,"Per Game",'<br>','<sup>',toupper(paste("Season Avg:",round(avg_pos,1),"/","Avg Last",params$games,"games:",round(avg_lastx_pos,1))),'</sup>'))))


```



```{r Exploratory Possessions Rank, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE, error = TRUE}


player_data_advanced_expanded %>% mutate({{metric}} := replace_na(.data[[metric]],0)) %>% filter(typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(ptsPaint = sum(ptsPaint),ptsFastBreak = sum(ptsFastBreak), GP = n(), possessions = sum(possessions)) %>% mutate(rank = order(order(possessions, decreasing = T))) %>% mutate(axis = paste0(namePlayer," (", rank,")")) %>% ggplot(aes(x = reorder(axis,possessions),y = possessions, fill = ifelse(namePlayer == params$player,"high","default"))) + geom_bar(stat = "identity") + coord_flip() + theme_minimal() + labs(x = "Player (Team Rank)", y = "Possessions") + ggtitle("Regular Season Possessions") + geom_text(aes(label = possessions), position = position_dodge(width = 0.9),hjust = -0.25) + scale_fill_manual(values = c(high = primary_color, default = "grey45")) + guides(fill = FALSE)




```


```{r Machine Learning, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", eval = FALSE, error = TRUE}

metric = c("pts")

RMSE <- function(true,predicted) {
  sqrt(mean((true - predicted)^2))
}

y <- player_data$pts
index <- createDataPartition(y,times =1,p = 0.2, list = FALSE)
test_set <- player_data[index, ]
train_set <- player_data[-index, ]


#Season Avg

mu <- mean(train_set$pts)

model1_rmse <- RMSE(test_set$pts,mu)

#Location Avg

mu_location <- train_set %>% group_by(locationGame) %>% summarize(b = mean(pts-mu))

prediction <- test_set %>% left_join(mu_location, by = 'locationGame') %>% mutate(predicted = mu + b) %>% pull(predicted)

model2_rmse <- RMSE(test_set$pts,prediction)

#Month Average

mu_month <- train_set %>% mutate(month = as.character(month(dateGame))) %>% left_join(mu_location, by = "locationGame") %>% group_by(month) %>% summarize(b2 = mean(pts-mu-b))

prediction <- test_set %>% mutate(month = as.character(month(dateGame))) %>% left_join(mu_location, by = "locationGame") %>% left_join(mu_month, by = "month") %>% mutate(predicted = mu + b + b2) %>% pull(predicted)

model3_rmse <- RMSE(test_set$pts,prediction)

p <- test_set %>% mutate(month = as.character(month(dateGame))) %>% left_join(mu_location, by = "locationGame") %>% left_join(mu_month, by = "month") %>% mutate(predicted = mu + b + b2) %>% ggplot(aes(x = dateGame)) + geom_line(aes(y = pts, group = 1), color = "blue") + geom_line(aes(y = predicted, group = 1), color = "red", linetype = "dashed")

ggplotly(p)


#Weekday Average

mu_weekday <- train_set %>% mutate(day = weekdays(dateGame), abbreviate = TRUE) %>% left_join(mu_location, by = "locationGame") %>% group_by(day) %>% summarize(b2 = mean(pts - mu - b))

prediction <- test_set %>% mutate(day = weekdays(dateGame), abbreviate = TRUE) %>% left_join(mu_location, by = "locationGame") %>% left_join(mu_weekday, by = "day") %>% mutate(predicted = mu + b + b2) %>% pull(predicted)

model3_rmse <- RMSE(test_set$pts,prediction)


fit <- lm(pts ~ minutes + fg3a+ countDaysRestPlayer + fga + ast + stl + tov + locationGame, data = player_data)

p <- player_data %>% mutate(R_hat = predict(fit,newdata = player_data)) %>% ggplot(aes(R_hat, pts)) + geom_point() + geom_abline()


```



Sidebar {.sidebar}
=======================================================================

<center> <p>Prop Report For `r params$player` Created on `r Sys.Date()`</p></center>


```{r player photo side, echo = FALSE, warning=FALSE, message = FALSE, error = TRUE, out.width = "60%", out.height = "60%", fig.align='center'}

library(rsvg)




pic <- image_read(photo)

#logo <- image_read_svg(team_logo)



p <- ggdraw() + draw_image(photo) + theme(plot.background = element_rect(fill = "#F2DFDD",color = "#F2DFDD"))

print(p, info = FALSE)

#profile <- invisible(capture.output(player_profiles(player_ids = player_id[1], nest_data = F, return_message = F)))



```



<center> <p><b>`r team_name` </b></p></center>
<center> <p><b>Number: #`r roster_data$numberJersey` </b></p></center>
<center> <p><b>Age: `r roster_data$agePlayer` </b></p></center>
<center> <p><b>Position: `r roster_data$groupPosition` </b></p></center>
<center> <p><b>Experience: `r roster_data$countYearsExperience` years </b></p></center>
<center> <p><b>Height: `r floor(roster_data$heightInches/12)`'`r ((roster_data$heightInches/12)-floor(roster_data$heightInches/12))*12`" </b></p></center>
<center> <p><b>Weight: `r roster_data$weightLBS` lbs </b></p></center>







The Low Down {data-navmenu-icon="fa-signal" data-orientation=columns}
=======================================================================

Column {data-width=200}
-----------------------------------------------------------------------

<center> <p><b>`r current_season` Regular Season</b></p></center>

### PPG


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}

ppg <- player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(ppg = mean(pts)) %>% pull(ppg)


valueBox(round(ppg,1))


```

### APG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}


apg <- player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(apg = mean(ast)) %>% pull(apg)

valueBox(round(apg,1))


```

### RPG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(rpg = mean(treb)) %>% pull(rpg),1))


```

### SPG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(spg = mean(stl)) %>% pull(spg),1))


```

### BPG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(bpg = mean(blk)) %>% pull(bpg),1))


```

### 3-Pointers Made

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(fg3m = mean(fg3m)) %>% pull(fg3m),1))


```

### 3-Pointers Attempted

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(fg3a = mean(fg3a)) %>% pull(fg3a),1))

nxt <- player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% mutate(game = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% pull(game)

nxt_date <- player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% mutate(game = ifelse(locationGame == "A",paste0("@ ",slugOpponent),paste0("vs ",slugOpponent))) %>% pull(dateGame)


```


Column {data-width=200}
-----------------------------------------------------------------------

<center> <p><b>Latest Performance `r nxt_date` `r nxt`</b></p></center>

### Points


```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(pts),1))


```

### Assists

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}


valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(ast),1))

```

### Rebounds

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(treb),1))


```

### Steals

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(stl),1))


```

### Blocks

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(blk),1))


```

### 3-Pointers Made

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(fg3m),1))


```

### 3-Pointers Attempted

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% arrange(desc(dateGame)) %>% head(1) %>% pull(fg3a),1))


```




Column {data-width=200}
-----------------------------------------------------------------------

<center> <p><b>`r current_season` Regular Season Combo</b></p></center>


### Points + Rebounds + Assists

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(value = mean(pts+treb+ast)) %>% pull(value),1))


```


### Points + Assists

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(value = mean(pts+ast)) %>% pull(value),1))


```



### Points + Rebounds

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(value = mean(pts+treb)) %>% pull(value),1))


```

### Rebounds + Assists

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(value = mean(ast+treb)) %>% pull(value),1))


```


### Steals + Blocks

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(player_data %>% filter(slugSeason == current_season, typeSeason == "Regular Season") %>% group_by(namePlayer) %>% summarize(value = mean(stl+blk)) %>% pull(value),1))


```


Column {data-width=200}
-----------------------------------------------------------------------

<center> <p><b>`r current_season` Regular Season Q1</b></p></center>

### PPG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(firstq_makes %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(slugSeason) %>% summarize(ppg = mean(pts)) %>% pull(ppg),1))


```

### APG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(firstq_assists %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(slugSeason) %>% summarize(apg = mean(assists)) %>% pull(apg),1))


```


### RPG

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.align = "center", error = TRUE}



valueBox(round(firstq_rebounds %>% filter(typeSeason == "Regular Season", slugSeason == current_season) %>% group_by(slugSeason) %>% summarize(rpg = mean(rebounds)) %>% pull(rpg),1))


```


